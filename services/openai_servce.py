import openai
import streamlit as st
from typing import Generator, Dict, Any
import json

class OpenAIService:
    """OpenAIæœåŠ¡ç±»ï¼Œæä¾›æµå¼å’Œéæµå¼è¯·æ±‚åŠŸèƒ½"""
    
    def __init__(self, api_key: str, base_url: str = None, model_name: str = "gpt-3.5-turbo"):
        """
        åˆå§‹åŒ–OpenAIæœåŠ¡
        
        Args:
            api_key: OpenAI APIå¯†é’¥
            base_url: åŸºç¡€URLï¼ˆå¯é€‰ï¼Œç”¨äºä»£ç†ï¼‰
            model_name: æ¨¡å‹åç§°
        """
        self.api_key = api_key
        self.base_url = base_url
        self.model_name = model_name
        
        # åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
        self.client = openai.OpenAI(
            api_key=api_key,
            base_url=base_url if base_url else None
        )
    
    def stream_chat_completion(
        self, 
        messages: list, 
        temperature: float = 0.7,
        response_format: dict = None
    ) -> Generator[str, None, None]:
        """
        æµå¼èŠå¤©å®Œæˆè¯·æ±‚
        
        Args:
            messages: æ¶ˆæ¯åˆ—è¡¨
            temperature: æ¸©åº¦å‚æ•°ï¼Œæ§åˆ¶éšæœºæ€§
            
        Yields:
            æµå¼è¿”å›çš„æ–‡æœ¬ç‰‡æ®µ
        """
        try:
            stream = self.client.chat.completions.create(
                model=self.model_name,
                messages=messages,
                temperature=temperature,
                stream=True,
                **({"response_format": response_format} if response_format is not None else {})
            )
            
            for chunk in stream:
                if chunk.choices[0].delta.content is not None:
                    yield chunk.choices[0].delta.content
                    
        except Exception as e:
            yield f"é”™è¯¯: {str(e)}"
    
    def analyze_document(self, file_content: str, analysis_type: str = "overview") -> Generator[str, None, None]:
        """
        åˆ†ææ–‡æ¡£å†…å®¹
        
        Args:
            file_content: æ–‡æ¡£å†…å®¹
            analysis_type: åˆ†æç±»å‹ ("overview" æˆ– "requirements")
            
        Yields:
            æµå¼åˆ†æç»“æœ
        """
        if analysis_type == "overview":
            system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ‹›æ ‡æ–‡ä»¶åˆ†æä¸“å®¶ã€‚è¯·åˆ†æä¸Šä¼ çš„æ‹›æ ‡æ–‡ä»¶ï¼Œæå–å¹¶æ€»ç»“é¡¹ç›®æ¦‚è¿°ä¿¡æ¯ã€‚
            
è¯·é‡ç‚¹å…³æ³¨ä»¥ä¸‹æ–¹é¢ï¼š
1. é¡¹ç›®åç§°å’ŒåŸºæœ¬ä¿¡æ¯
2. é¡¹ç›®èƒŒæ™¯å’Œç›®çš„
3. é¡¹ç›®è§„æ¨¡å’Œé¢„ç®—
4. é¡¹ç›®æ—¶é—´å®‰æ’
5. ä¸»è¦æŠ€æœ¯ç‰¹ç‚¹
6. å…³é”®è¦æ±‚

å·¥ä½œè¦æ±‚ï¼š
1. ä¿æŒæå–ä¿¡æ¯çš„å…¨é¢æ€§å’Œå‡†ç¡®æ€§ï¼Œå°½é‡ä½¿ç”¨åŸæ–‡å†…å®¹ï¼Œä¸è¦è‡ªå·±ç¼–å†™
2. åªå…³æ³¨ä¸é¡¹ç›®å®æ–½æœ‰å…³çš„å†…å®¹ï¼Œä¸æå–å•†åŠ¡ä¿¡æ¯
3. ç›´æ¥è¿”å›æ•´ç†å¥½çš„é¡¹ç›®æ¦‚è¿°ï¼Œé™¤æ­¤ä¹‹å¤–ä¸è¿”å›ä»»ä½•å…¶ä»–å†…å®¹
"""
        else:  # requirements
            system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ‹›æ ‡æ–‡ä»¶åˆ†æä¸“å®¶ã€‚è¯·åˆ†æä¸Šä¼ çš„æ‹›æ ‡æ–‡ä»¶ï¼Œæå–æŠ€æœ¯è¯„åˆ†è¦æ±‚,ä¸ºç¼–å†™æŠ•æ ‡æ–‡ä»¶ä¸­çš„æŠ€æœ¯æ–¹æ¡ˆåšå‡†å¤‡ã€‚
            
è¯·é‡ç‚¹å…³æ³¨ä»¥ä¸‹æ–¹é¢ï¼š
1. ç†è§£æŠ€æœ¯è¯„åˆ†çš„æ„æ€ï¼šç”¨äºç¼–å†™ã€è¯„æ¯”æŠ•æ ‡æ–‡ä»¶ä¸­æŠ€æœ¯æ ‡çš„æ ‡å‡†ï¼Œå…³æ³¨æŠ€æœ¯æ–¹æ¡ˆã€å®æ–½è®¡åˆ’ã€æŠ€æœ¯èƒ½åŠ›ã€è´¨é‡æ§åˆ¶ã€åˆ›æ–°æ€§ç­‰å†…å®¹ï¼Œé¿å…æ··æ·†å•†åŠ¡è¯„åˆ†ï¼ˆèµ„è´¨ã€ä¿¡èª‰ã€åˆåŒæ¡æ¬¾ï¼‰å’Œä»·æ ¼è¯„åˆ†ï¼ˆæŠ¥ä»·é‡‘é¢ï¼‰
2. ä»…æå–æŠ€æœ¯è¯„åˆ†é¡¹åŠç›¸å…³è¦æ±‚ï¼Œä¸åŒ…æ‹¬å•†åŠ¡ã€ä»·æ ¼åŠå…¶ä»–
3. ç”Ÿæˆå†…å®¹è¦ç¡®ä¿æ˜¯ä»æ‹›æ ‡æ–‡ä»¶ä¸­æå–çš„ï¼Œä¸è¦è‡ªå·±ç¼–å†™
4. ç›´æ¥è¿”å›æ•´ç†å¥½çš„æŠ€æœ¯è¯„åˆ†è¦æ±‚ï¼Œé™¤æ­¤ä¹‹å¤–ä¸è¿”å›ä»»ä½•å…¶ä»–å†…å®¹
"""
        analysis_type_cn = "é¡¹ç›®æ¦‚è¿°" if analysis_type == "overview" else "æŠ€æœ¯è¯„åˆ†è¦æ±‚"
        user_prompt = f"è¯·åˆ†æä»¥ä¸‹æ‹›æ ‡æ–‡ä»¶å†…å®¹ï¼Œæå–{analysis_type_cn}ä¿¡æ¯ï¼š\n\n{file_content}"
        
        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        # æµå¼è¿”å›åˆ†æç»“æœ
        for chunk in self.stream_chat_completion(messages, temperature=0.3):
            yield chunk
            
    def generate_outline(self, overview: str, requirements: str) -> Generator[str, None, None]:
        """
        ç”Ÿæˆæ ‡ä¹¦ç›®å½•ç»“æ„
        
        Args:
            overview: é¡¹ç›®æ¦‚è¿°ä¿¡æ¯
            requirements: æŠ€æœ¯è¯„åˆ†è¦æ±‚ä¿¡æ¯
            
        Yields:
            æµå¼è¿”å›çš„JSONæ ¼å¼ç›®å½•ç»“æ„
        """
        system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ ‡ä¹¦ç¼–å†™ä¸“å®¶ã€‚æ ¹æ®æä¾›çš„é¡¹ç›®æ¦‚è¿°å’ŒæŠ€æœ¯è¯„åˆ†è¦æ±‚ï¼Œç”ŸæˆæŠ•æ ‡æ–‡ä»¶ä¸­æŠ€æœ¯æ ‡éƒ¨åˆ†çš„ç›®å½•ç»“æ„ã€‚

è¦æ±‚ï¼š
1. ç›®å½•ç»“æ„è¦å…¨é¢è¦†ç›–æŠ€æœ¯æ ‡çš„æ‰€æœ‰å¿…è¦ç« èŠ‚
2. ç« èŠ‚åç§°è¦ä¸“ä¸šã€å‡†ç¡®ï¼Œç¬¦åˆæŠ•æ ‡æ–‡ä»¶è§„èŒƒ
3. ä¸€çº§ç›®å½•åç§°è¦ä¸æŠ€æœ¯è¯„åˆ†è¦æ±‚ä¸­çš„ç« èŠ‚åç§°ä¸€è‡´ï¼Œå¦‚æœæŠ€æœ¯è¯„åˆ†è¦æ±‚ä¸­æ²¡æœ‰ç« èŠ‚åç§°ï¼Œåˆ™ç»“åˆæŠ€æœ¯è¯„åˆ†è¦æ±‚ä¸­çš„å†…å®¹ï¼Œç”Ÿæˆä¸€çº§ç›®å½•åç§°
4. ä¸€å…±åŒ…æ‹¬ä¸‰çº§ç›®å½•
5. è¿”å›æ ‡å‡†JSONæ ¼å¼ï¼ŒåŒ…å«ç« èŠ‚ç¼–å·ã€æ ‡é¢˜ã€æè¿°å’Œå­ç« èŠ‚
6. é™¤äº†JSONç»“æœå¤–ï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹

JSONæ ¼å¼è¦æ±‚ï¼š
{
  "outline": [
    {
      "id": "1",
      "title": "",
      "description": "",
      "children": [
        {
          "id": "1.1",
          "title": "",
          "description": "",
          "children":[
              {
                "id": "1.1.1",
                "title": "",
                "description": ""
              }
          ]
        }
      ]
    }
  ]
}
"""
        
        user_prompt = f"""è¯·åŸºäºä»¥ä¸‹é¡¹ç›®ä¿¡æ¯ç”Ÿæˆæ ‡ä¹¦ç›®å½•ç»“æ„ï¼š

é¡¹ç›®æ¦‚è¿°ï¼š
{overview}

æŠ€æœ¯è¯„åˆ†è¦æ±‚ï¼š
{requirements}

è¯·ç”Ÿæˆå®Œæ•´çš„æŠ€æœ¯æ ‡ç›®å½•ç»“æ„ï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰æŠ€æœ¯è¯„åˆ†è¦ç‚¹ã€‚"""
        
        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        # æµå¼è¿”å›ç›®å½•ç»“æ„
        for chunk in self.stream_chat_completion(messages, temperature=0.7, response_format={"type": "json_object"}):
            print(chunk, end="")
            yield chunk

    def generate_content_single(self, outline: str) -> Generator[str, None, None]:
        """
        é€’å½’éå†outlineï¼Œä¸ºå¶å­èŠ‚ç‚¹ç”Ÿæˆå†…å®¹

        Args:
            outline: JSONæ ¼å¼çš„outlineå­—ç¬¦ä¸²

        Yields:
            æµå¼è¿”å›å¤„ç†çŠ¶æ€å’Œç”Ÿæˆçš„content
        """
        outline = '{"outline":[{"id":"1","title":"é¡¹ç›®æ€»ä½“æ¦‚è¿°åŠè¿ç»´æ–¹æ¡ˆ11","description":"é’ˆå¯¹æœ¬é¡¹ç›®çš„æ·±åˆ»è®¤è¯†ï¼Œæ€»ä½“æ¦‚è¿°æ¸…æ™°ã€åˆç†ï¼Œè¿ç»´æ–¹æ¡ˆä»¥åŠæªæ–½å…ˆè¿›ã€æˆç†Ÿå®Œå…¨æ»¡è¶³è§„èŒƒè¦æ±‚","children":[{"id":"1.1","title":"é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡22","description":"åˆ†æé¡¹ç›®èƒŒæ™¯ï¼Œæ˜ç¡®é¡¹ç›®ç›®æ ‡ä¸æ„ä¹‰","children":[{"id":"1.1.1","title":"é¡¹ç›®èƒŒæ™¯åˆ†æ33","description":"åˆ†æå¤©æ´¥æ¸¯ä¿ç¨åŒºæ¶ˆé˜²æ•‘æ´æ”¯é˜Ÿæ¶ˆé˜²ç‰©è”ç½‘è¿œç¨‹ç›‘æ§ç³»ç»Ÿè¿ç»´æœåŠ¡é¡¹ç›®çš„èƒŒæ™¯æƒ…å†µ"},{"id":"1.1.2","title":"é¡¹ç›®ç›®æ ‡ä¸æ„ä¹‰","description":"æ˜ç¡®æœ¬é¡¹ç›®çš„ç›®æ ‡ä¸å®æ–½æ„ä¹‰ï¼ŒåŒ…æ‹¬260å®¶è”ç½‘å•ä½å‰ç«¯è®¾å¤‡ç”µæ± æ›´æ¢ç­‰å…³é”®ä»»åŠ¡"}]},{"id":"1.2","title":"é¡¹ç›®éœ€æ±‚åˆ†æ","description":"å…¨é¢åˆ†æé¡¹ç›®çš„åŠŸèƒ½ã€æ€§èƒ½å’Œå®‰å…¨éœ€æ±‚","children":[{"id":"1.2.1","title":"åŠŸèƒ½éœ€æ±‚åˆ†æ","description":"åˆ†ææ¶ˆé˜²ç‰©è”ç½‘è¿œç¨‹ç›‘æ§ç³»ç»Ÿçš„åŠŸèƒ½éœ€æ±‚ï¼ŒåŒ…æ‹¬ç›‘æ§ä¸­å¿ƒä¸IDCæœºæˆ¿åœºåœ°ã€é€šè®¯é“¾è·¯ç­‰"},{"id":"1.2.2","title":"æ€§èƒ½éœ€æ±‚åˆ†æ","description":"åˆ†æç³»ç»Ÿæ€§èƒ½éœ€æ±‚ï¼ŒåŒ…æ‹¬å›ºå®šIPä¸“çº¿å¸¦å®½ã€ç‰©è”ç½‘å¡æµé‡ã€è§†é¢‘ä¸“çº¿å¸¦å®½ç­‰"},{"id":"1.2.3","title":"å®‰å…¨éœ€æ±‚åˆ†æ","description":"åˆ†æç³»ç»Ÿå®‰å…¨éœ€æ±‚ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’Œç³»ç»Ÿç¨³å®šè¿è¡Œ"}]},{"id":"1.3","title":"è¿ç»´æœåŠ¡æ€»ä½“æ–¹æ¡ˆ","description":"è®¾è®¡å…¨é¢çš„è¿ç»´æœåŠ¡æ–¹æ¡ˆï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ","children":[{"id":"1.3.1","title":"è¿ç»´æœåŠ¡èŒƒå›´ä¸å†…å®¹","description":"æ˜ç¡®è¿ç»´æœåŠ¡çš„èŒƒå›´å’Œå…·ä½“å†…å®¹ï¼ŒåŒ…æ‹¬å¹³å°è½¯ç¡¬ä»¶è¿è¡Œç»´æŠ¤å’Œå‰ç«¯è®¾å¤‡ç”µæ± æ›´æ¢"},{"id":"1.3.2","title":"è¿ç»´æœåŠ¡æµç¨‹è®¾è®¡","description":"è®¾è®¡ç§‘å­¦åˆç†çš„è¿ç»´æœåŠ¡æµç¨‹ï¼Œç¡®ä¿æœåŠ¡é«˜æ•ˆæœ‰åº"},{"id":"1.3.3","title":"è¿ç»´æœåŠ¡è´¨é‡ä¿éšœæªæ–½","description":"åˆ¶å®šè¿ç»´æœåŠ¡è´¨é‡ä¿éšœæªæ–½ï¼Œç¡®ä¿æœåŠ¡è´¨é‡è¾¾æ ‡"}]},{"id":"1.4","title":"æŠ€æœ¯æ–¹æ¡ˆæ¦‚è¿°","description":"æ¦‚è¿°é¡¹ç›®æŠ€æœ¯æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ¶æ„å’Œå…³é”®æŠ€æœ¯è·¯çº¿","children":[{"id":"1.4.1","title":"ç³»ç»Ÿæ¶æ„æ¦‚è¿°","description":"æ¦‚è¿°æ¶ˆé˜²ç‰©è”ç½‘è¿œç¨‹ç›‘æ§ç³»ç»Ÿçš„æ•´ä½“æ¶æ„"},{"id":"1.4.2","title":"å…³é”®æŠ€æœ¯è·¯çº¿","description":"ä»‹ç»é¡¹ç›®é‡‡ç”¨çš„å…³é”®æŠ€æœ¯è·¯çº¿å’Œæ–¹æ³•"},{"id":"1.4.3","title":"æŠ€æœ¯åˆ›æ–°ç‚¹","description":"é˜è¿°é¡¹ç›®ä¸­çš„æŠ€æœ¯åˆ›æ–°ç‚¹å’Œä¼˜åŠ¿"}]}]},{"id":"8","title":"æ–°å¢ä¸€çº§","description":"","children":[{"id":"8.1","title":"äºŒçº§","description":"","children":[{"id":"8.1.1","title":"ä¸‰çº§","description":"","children":[]}]}]},{"id":"2","title":"æœ¬é¡¹ç›®æŠ•å…¥äººå‘˜å›¢é˜Ÿçš„è¯„ä»·","description":"æŠ•æ ‡äººæä¾›ä¸ºæœ¬é¡¹ç›®æ•´ä½“äººå‘˜é…ç½®æ–¹æ¡ˆï¼ŒæœåŠ¡äººå‘˜çš„æŠ€æœ¯å®åŠ›ã€æœåŠ¡ç»éªŒã€äººå‘˜é…ç½®è¯„ä»·","children":[{"id":"2.1","title":"äººå‘˜å›¢é˜Ÿæ€»ä½“æ„æˆ","description":"æè¿°äººå‘˜å›¢é˜Ÿçš„æ€»ä½“æ„æˆæƒ…å†µ","children":[{"id":"2.1.1","title":"å›¢é˜Ÿè§„æ¨¡ä¸ç»“æ„","description":"ä»‹ç»å›¢é˜Ÿè§„æ¨¡å’Œç»“æ„ï¼ŒåŒ…æ‹¬ç›‘æ§ä¸­å¿ƒå€¼å®ˆ8äººã€å‰ç«¯è®¾å¤‡è¿ç»´3äººã€ç³»ç»Ÿè½¯ä»¶è¿ç»´ä¸å°‘äº2äºº"},{"id":"2.1.2","title":"å›¢é˜Ÿä¸“ä¸šèƒ½åŠ›æ¦‚è¿°","description":"æ¦‚è¿°å›¢é˜Ÿçš„æ•´ä½“ä¸“ä¸šèƒ½åŠ›å’ŒæŠ€æœ¯æ°´å¹³"},{"id":"2.1.3","title":"å›¢é˜Ÿèµ„è´¨è¯ä¹¦æƒ…å†µ","description":"ä»‹ç»å›¢é˜Ÿæˆå‘˜æŒæœ‰çš„ç›¸å…³èµ„è´¨è¯ä¹¦ï¼ŒåŒ…æ‹¬åˆçº§æ¶ˆé˜²å‘˜è¯ä¹¦ç­‰"}]},{"id":"2.2","title":"æ ¸å¿ƒæŠ€æœ¯äººå‘˜ä»‹ç»","description":"è¯¦ç»†ä»‹ç»é¡¹ç›®æ ¸å¿ƒæŠ€æœ¯äººå‘˜æƒ…å†µ","children":[{"id":"2.2.1","title":"é¡¹ç›®è´Ÿè´£äººä»‹ç»","description":"ä»‹ç»é¡¹ç›®è´Ÿè´£äººçš„èµ„è´¨ã€ç»éªŒå’Œèƒ½åŠ›"},{"id":"2.2.2","title":"æŠ€æœ¯è´Ÿè´£äººä»‹ç»","description":"ä»‹ç»æŠ€æœ¯è´Ÿè´£äººçš„èµ„è´¨ã€ç»éªŒå’Œèƒ½åŠ›"},{"id":"2.2.3","title":"å…¶ä»–æ ¸å¿ƒæŠ€æœ¯äººå‘˜ä»‹ç»","description":"ä»‹ç»å…¶ä»–æ ¸å¿ƒæŠ€æœ¯äººå‘˜çš„èµ„è´¨ã€ç»éªŒå’Œèƒ½åŠ›"}]},{"id":"2.3","title":"å›¢é˜Ÿç»éªŒä¸ä¸šç»©","description":"å±•ç¤ºå›¢é˜Ÿçš„ç»éªŒä¸ä¸šç»©","children":[{"id":"2.3.1","title":"å›¢é˜Ÿç±»ä¼¼é¡¹ç›®ç»éªŒ","description":"ä»‹ç»å›¢é˜Ÿåœ¨ç±»ä¼¼é¡¹ç›®ä¸­çš„ç»éªŒ"},{"id":"2.3.2","title":"å›¢é˜Ÿè¿‡å¾€ä¸šç»©å±•ç¤º","description":"å±•ç¤ºå›¢é˜Ÿçš„è¿‡å¾€ä¸šç»©å’Œæˆå°±"},{"id":"2.3.3","title":"å›¢é˜Ÿä¸“ä¸šèƒ½åŠ›è®¤è¯","description":"ä»‹ç»å›¢é˜Ÿæˆå‘˜çš„ä¸“ä¸šèƒ½åŠ›è®¤è¯æƒ…å†µ"}]}]},{"id":"3","title":"äººå‘˜ç»„ç»‡æ–¹æ¡ˆåŠåˆ†å·¥èŒè´£è¯„ä»·","description":"äººå‘˜é…å¤‡æ–¹æ¡ˆåˆç†ï¼Œç»„ç»‡å®‰æ’å®Œå–„ï¼Œç»éªŒä¸°å¯Œçš„ç»„ç»‡æ–¹æ¡ˆåŠåˆ†å·¥èŒè´£","children":[{"id":"3.1","title":"ç»„ç»‡æ¶æ„è®¾è®¡","description":"è®¾è®¡åˆç†çš„ç»„ç»‡æ¶æ„","children":[{"id":"3.1.1","title":"é¡¹ç›®ç»„ç»‡æ¶æ„å›¾","description":"æä¾›æ¸…æ™°çš„é¡¹ç›®ç»„ç»‡æ¶æ„å›¾"},{"id":"3.1.2","title":"ç®¡ç†å±‚çº§è®¾è®¡","description":"è®¾è®¡åˆç†çš„ç®¡ç†å±‚çº§ï¼Œç¡®ä¿é«˜æ•ˆç®¡ç†"},{"id":"3.1.3","title":"åä½œæœºåˆ¶è®¾è®¡","description":"è®¾è®¡æœ‰æ•ˆçš„å›¢é˜Ÿåä½œæœºåˆ¶"}]},{"id":"3.2","title":"å²—ä½èŒè´£åˆ’åˆ†","description":"æ˜ç¡®åˆ’åˆ†å„å²—ä½èŒè´£","children":[{"id":"3.2.1","title":"é¡¹ç›®ç»ç†èŒè´£","description":"æ˜ç¡®é¡¹ç›®ç»ç†çš„èŒè´£å’Œæƒé™"},{"id":"3.2.2","title":"æŠ€æœ¯äººå‘˜èŒè´£","description":"æ˜ç¡®æŠ€æœ¯äººå‘˜çš„èŒè´£å’Œåˆ†å·¥"},{"id":"3.2.3","title":"ç›‘æ§ä¸­å¿ƒå€¼å®ˆäººå‘˜èŒè´£","description":"æ˜ç¡®ç›‘æ§ä¸­å¿ƒå€¼å®ˆäººå‘˜çš„èŒè´£å’Œå·¥ä½œè¦æ±‚"}]},{"id":"3.3","title":"äººå‘˜å·¥ä½œæµç¨‹","description":"è®¾è®¡ç§‘å­¦åˆç†çš„äººå‘˜å·¥ä½œæµç¨‹","children":[{"id":"3.3.1","title":"æ—¥å¸¸å·¥ä½œæµç¨‹","description":"è®¾è®¡æ—¥å¸¸å·¥ä½œçš„æµç¨‹å’Œè§„èŒƒ"},{"id":"3.3.2","title":"åº”æ€¥å“åº”æµç¨‹","description":"è®¾è®¡åº”æ€¥å“åº”çš„æµç¨‹å’Œæœºåˆ¶"},{"id":"3.3.3","title":"æ²Ÿé€šåè°ƒæœºåˆ¶","description":"è®¾è®¡å›¢é˜Ÿå†…å¤–æ²Ÿé€šåè°ƒçš„æœºåˆ¶"}]}]},{"id":"4","title":"å‰ç«¯ç¡¬ä»¶è®¾å¤‡è¿ç»´æ–¹æ¡ˆ","description":"æ¶ˆé˜²ç‰©è”ç½‘å‰ç«¯ç¡¬ä»¶è®¾å¤‡è¿ç»´ï¼Œç»´ä¿ã€ç»´ä¿®æ–¹æ¡ˆè€ƒè™‘å…¨é¢ï¼Œæ¶µç›–æ‰€æœ‰å‰ç«¯è®¾å¤‡","children":[{"id":"4.1","title":"å‰ç«¯è®¾å¤‡æ¦‚å†µ","description":"æ¦‚è¿°å‰ç«¯è®¾å¤‡çš„æƒ…å†µ","children":[{"id":"4.1.1","title":"è®¾å¤‡ç±»å‹ä¸æ•°é‡ç»Ÿè®¡","description":"ç»Ÿè®¡å‰ç«¯è®¾å¤‡çš„ç±»å‹å’Œæ•°é‡ï¼ŒåŒ…æ‹¬ç”¨æˆ·ä¿¡æ¯ä¼ è¾“è£…ç½®ã€å‹åŠ›å’Œæ¶²ä½ä¼ æ„Ÿå™¨ç­‰"},{"id":"4.1.2","title":"è®¾å¤‡åˆ†å¸ƒæƒ…å†µ","description":"æè¿°å‰ç«¯è®¾å¤‡åœ¨ç©ºæ¸¯ã€æµ·æ¸¯å’Œä¸´æ¸¯ä¸‰ä¸ªç»æµåŒºçš„åˆ†å¸ƒæƒ…å†µ"},{"id":"4.1.3","title":"è®¾å¤‡è¿è¡ŒçŠ¶æ€åˆ†æ","description":"åˆ†æå‰ç«¯è®¾å¤‡çš„è¿è¡ŒçŠ¶æ€å’Œæ½œåœ¨é—®é¢˜"}]},{"id":"4.2","title":"è®¾å¤‡ç»´ä¿æ–¹æ¡ˆ","description":"åˆ¶å®šè®¾å¤‡ç»´ä¿æ–¹æ¡ˆ","children":[{"id":"4.2.1","title":"æ—¥å¸¸å·¡æ£€æ–¹æ¡ˆ","description":"åˆ¶å®šæ—¥å¸¸å·¡æ£€çš„æ–¹æ¡ˆå’Œé¢‘æ¬¡"},{"id":"4.2.2","title":"å®šæœŸç»´æŠ¤æ–¹æ¡ˆ","description":"åˆ¶å®šå®šæœŸç»´æŠ¤çš„æ–¹æ¡ˆå’Œè®¡åˆ’"},{"id":"4.2.3","title":"è®¾å¤‡æ›´æ¢è®¡åˆ’","description":"åˆ¶å®šè®¾å¤‡æ›´æ¢çš„è®¡åˆ’ï¼Œç‰¹åˆ«æ˜¯ç”µæ± æ›´æ¢è®¡åˆ’"}]},{"id":"4.3","title":"è®¾å¤‡ç»´ä¿®æ–¹æ¡ˆ","description":"åˆ¶å®šè®¾å¤‡ç»´ä¿®æ–¹æ¡ˆ","children":[{"id":"4.3.1","title":"æ•…éšœè¯Šæ–­æµç¨‹","description":"è®¾è®¡è®¾å¤‡æ•…éšœçš„è¯Šæ–­æµç¨‹"},{"id":"4.3.2","title":"ç»´ä¿®å“åº”æœºåˆ¶","description":"è®¾è®¡è®¾å¤‡ç»´ä¿®çš„å“åº”æœºåˆ¶"},{"id":"4.3.3","title":"ç»´ä¿®è´¨é‡ä¿éšœæªæ–½","description":"åˆ¶å®šç»´ä¿®è´¨é‡ä¿éšœæªæ–½"}]},{"id":"4.4","title":"ç”µæ± æ›´æ¢ä¸“é¡¹æ–¹æ¡ˆ","description":"åˆ¶å®šç”µæ± æ›´æ¢ä¸“é¡¹æ–¹æ¡ˆ","children":[{"id":"4.4.1","title":"ç”µæ± æ›´æ¢è®¡åˆ’","description":"åˆ¶å®š260å®¶è”ç½‘å•ä½å‰ç«¯è®¾å¤‡ç”µæ± çš„è¯¦ç»†æ›´æ¢è®¡åˆ’"},{"id":"4.4.2","title":"ç”µæ± æ›´æ¢æµç¨‹","description":"è®¾è®¡ç”µæ± æ›´æ¢çš„å…·ä½“æµç¨‹å’Œæ­¥éª¤"},{"id":"4.4.3","title":"æ›´æ¢åæµ‹è¯•ä¸éªŒæ”¶","description":"è®¾è®¡ç”µæ± æ›´æ¢åçš„æµ‹è¯•ä¸éªŒæ”¶æµç¨‹"}]}]},{"id":"5","title":"è½¯ç¡¬ä»¶æ•…éšœåº”æ€¥å¤„ç†æ–¹æ¡ˆ","description":"è½¯ç¡¬ä»¶æ•…éšœåº”æ€¥å¤„ç†æ–¹æ¡ˆæªæ–½åˆç†æ€§ã€å¯è¡Œæ€§ã€æŒ‡å¯¼æ€§é«˜","children":[{"id":"5.1","title":"åº”æ€¥å¤„ç†æ€»ä½“æ–¹æ¡ˆ","description":"åˆ¶å®šåº”æ€¥å¤„ç†çš„æ€»ä½“æ–¹æ¡ˆ","children":[{"id":"5.1.1","title":"åº”æ€¥å¤„ç†ç»„ç»‡æ¶æ„","description":"è®¾è®¡åº”æ€¥å¤„ç†çš„ç»„ç»‡æ¶æ„"},{"id":"5.1.2","title":"åº”æ€¥å“åº”çº§åˆ«å®šä¹‰","description":"å®šä¹‰ä¸åŒçº§åˆ«çš„åº”æ€¥å“åº”"},{"id":"5.1.3","title":"åº”æ€¥å¤„ç†æ€»ä½“æµç¨‹","description":"è®¾è®¡åº”æ€¥å¤„ç†çš„æ€»ä½“æµç¨‹"}]},{"id":"5.2","title":"ç¡¬ä»¶æ•…éšœåº”æ€¥å¤„ç†","description":"åˆ¶å®šç¡¬ä»¶æ•…éšœçš„åº”æ€¥å¤„ç†æ–¹æ¡ˆ","children":[{"id":"5.2.1","title":"å‰ç«¯è®¾å¤‡æ•…éšœåº”æ€¥å¤„ç†","description":"åˆ¶å®šå‰ç«¯è®¾å¤‡æ•…éšœçš„åº”æ€¥å¤„ç†æµç¨‹"},{"id":"5.2.2","title":"ç½‘ç»œè®¾å¤‡æ•…éšœåº”æ€¥å¤„ç†","description":"åˆ¶å®šç½‘ç»œè®¾å¤‡æ•…éšœçš„åº”æ€¥å¤„ç†æµç¨‹"},{"id":"5.2.3","title":"æœåŠ¡å™¨è®¾å¤‡æ•…éšœåº”æ€¥å¤„ç†","description":"åˆ¶å®šæœåŠ¡å™¨è®¾å¤‡æ•…éšœçš„åº”æ€¥å¤„ç†æµç¨‹"}]},{"id":"5.3","title":"è½¯ä»¶æ•…éšœåº”æ€¥å¤„ç†","description":"åˆ¶å®šè½¯ä»¶æ•…éšœçš„åº”æ€¥å¤„ç†æ–¹æ¡ˆ","children":[{"id":"5.3.1","title":"ç³»ç»Ÿè½¯ä»¶æ•…éšœåº”æ€¥å¤„ç†","description":"åˆ¶å®šç³»ç»Ÿè½¯ä»¶æ•…éšœçš„åº”æ€¥å¤„ç†æµç¨‹"},{"id":"5.3.2","title":"åº”ç”¨è½¯ä»¶æ•…éšœåº”æ€¥å¤„ç†","description":"åˆ¶å®šåº”ç”¨è½¯ä»¶æ•…éšœçš„åº”æ€¥å¤„ç†æµç¨‹"},{"id":"5.3.3","title":"æ•°æ®åº“æ•…éšœåº”æ€¥å¤„ç†","description":"åˆ¶å®šæ•°æ®åº“æ•…éšœçš„åº”æ€¥å¤„ç†æµç¨‹"}]},{"id":"5.4","title":"åº”æ€¥å¤„ç†ä¿éšœæªæ–½","description":"åˆ¶å®šåº”æ€¥å¤„ç†çš„ä¿éšœæªæ–½","children":[{"id":"5.4.1","title":"åº”æ€¥å¤‡å“å¤‡ä»¶ç®¡ç†","description":"åˆ¶å®šåº”æ€¥å¤‡å“å¤‡ä»¶çš„ç®¡ç†æ–¹æ¡ˆ"},{"id":"5.4.2","title":"åº”æ€¥å¤„ç†åŸ¹è®­ä¸æ¼”ç»ƒ","description":"åˆ¶å®šåº”æ€¥å¤„ç†çš„åŸ¹è®­ä¸æ¼”ç»ƒè®¡åˆ’"},{"id":"5.4.3","title":"åº”æ€¥å¤„ç†æ•ˆæœè¯„ä¼°","description":"åˆ¶å®šåº”æ€¥å¤„ç†æ•ˆæœçš„è¯„ä¼°æ–¹æ³•"}]}]},{"id":"6","title":"äººå‘˜ç¨³å®šæ€§ä¿éšœæªæ–½","description":"äººå‘˜ç¨³å®šæ€§ä¿éšœæªæ–½éå¸¸å®Œæ•´ï¼Œåˆ‡å®å¯è¡Œ","children":[{"id":"6.1","title":"äººå‘˜ç®¡ç†åˆ¶åº¦","description":"åˆ¶å®šå®Œå–„çš„äººå‘˜ç®¡ç†åˆ¶åº¦","children":[{"id":"6.1.1","title":"äººå‘˜æ‹›è˜ä¸é€‰æ‹”åˆ¶åº¦","description":"åˆ¶å®šé¡¹ç›®äººå‘˜çš„æ‹›è˜ä¸é€‰æ‹”åˆ¶åº¦"},{"id":"6.1.2","title":"äººå‘˜åŸ¹è®­ä¸å‘å±•åˆ¶åº¦","description":"åˆ¶å®šé¡¹ç›®äººå‘˜çš„åŸ¹è®­ä¸å‘å±•åˆ¶åº¦"},{"id":"6.1.3","title":"äººå‘˜è€ƒæ ¸ä¸æ¿€åŠ±åˆ¶åº¦","description":"åˆ¶å®šé¡¹ç›®äººå‘˜çš„è€ƒæ ¸ä¸æ¿€åŠ±åˆ¶åº¦"}]},{"id":"6.2","title":"äººå‘˜ç¨³å®šæ€§æªæ–½","description":"åˆ¶å®šåˆ‡å®å¯è¡Œçš„äººå‘˜ç¨³å®šæ€§æªæ–½","children":[{"id":"6.2.1","title":"è–ªé…¬ç¦åˆ©ä¿éšœæªæ–½","description":"åˆ¶å®šé¡¹ç›®äººå‘˜çš„è–ªé…¬ç¦åˆ©ä¿éšœæªæ–½"},{"id":"6.2.2","title":"èŒä¸šå‘å±•ä¿éšœæªæ–½","description":"åˆ¶å®šé¡¹ç›®äººå‘˜çš„èŒä¸šå‘å±•ä¿éšœæªæ–½"},{"id":"6.2.3","title":"å·¥ä½œç¯å¢ƒä¿éšœæªæ–½","description":"åˆ¶å®šé¡¹ç›®äººå‘˜çš„å·¥ä½œç¯å¢ƒä¿éšœæªæ–½"}]},{"id":"6.3","title":"äººå‘˜å˜æ›´ç®¡ç†","description":"åˆ¶å®šäººå‘˜å˜æ›´çš„ç®¡ç†æ–¹æ¡ˆ","children":[{"id":"6.3.1","title":"äººå‘˜å˜æ›´æµç¨‹","description":"åˆ¶å®šé¡¹ç›®äººå‘˜å˜æ›´çš„æµç¨‹å’Œå®¡æ‰¹æœºåˆ¶"},{"id":"6.3.2","title":"äººå‘˜äº¤æ¥ç®¡ç†","description":"åˆ¶å®šé¡¹ç›®äººå‘˜äº¤æ¥çš„ç®¡ç†æ–¹æ¡ˆ"},{"id":"6.3.3","title":"äººå‘˜å˜æ›´é£é™©æ§åˆ¶","description":"åˆ¶å®šé¡¹ç›®äººå‘˜å˜æ›´çš„é£é™©æ§åˆ¶æªæ–½"}]}]},{"id":"7","title":"å®šæœŸé¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ","description":"å®šæœŸé¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆéå¸¸ç»†è‡´ã€å…¨é¢ï¼Œå¯æ“ä½œæ€§å¼º","children":[{"id":"7.1","title":"é¢„é˜²æ€§æ£€æŸ¥æ€»ä½“æ–¹æ¡ˆ","description":"åˆ¶å®šé¢„é˜²æ€§æ£€æŸ¥çš„æ€»ä½“æ–¹æ¡ˆ","children":[{"id":"7.1.1","title":"æ£€æŸ¥å‘¨æœŸä¸é¢‘æ¬¡","description":"ç¡®å®šé¢„é˜²æ€§æ£€æŸ¥çš„å‘¨æœŸå’Œé¢‘æ¬¡"},{"id":"7.1.2","title":"æ£€æŸ¥å†…å®¹ä¸èŒƒå›´","description":"ç¡®å®šé¢„é˜²æ€§æ£€æŸ¥çš„å†…å®¹å’ŒèŒƒå›´"},{"id":"7.1.3","title":"æ£€æŸ¥æ ‡å‡†ä¸æ–¹æ³•","description":"ç¡®å®šé¢„é˜²æ€§æ£€æŸ¥çš„æ ‡å‡†å’Œæ–¹æ³•"}]},{"id":"7.2","title":"ç¡¬ä»¶è®¾å¤‡é¢„é˜²æ€§æ£€æŸ¥","description":"åˆ¶å®šç¡¬ä»¶è®¾å¤‡çš„é¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ","children":[{"id":"7.2.1","title":"å‰ç«¯è®¾å¤‡é¢„é˜²æ€§æ£€æŸ¥","description":"åˆ¶å®šå‰ç«¯è®¾å¤‡çš„é¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ"},{"id":"7.2.2","title":"ç½‘ç»œè®¾å¤‡é¢„é˜²æ€§æ£€æŸ¥","description":"åˆ¶å®šç½‘ç»œè®¾å¤‡çš„é¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ"},{"id":"7.2.3","title":"æœåŠ¡å™¨è®¾å¤‡é¢„é˜²æ€§æ£€æŸ¥","description":"åˆ¶å®šæœåŠ¡å™¨è®¾å¤‡çš„é¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ"}]},{"id":"7.3","title":"è½¯ä»¶ç³»ç»Ÿé¢„é˜²æ€§æ£€æŸ¥","description":"åˆ¶å®šè½¯ä»¶ç³»ç»Ÿçš„é¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ","children":[{"id":"7.3.1","title":"ç³»ç»Ÿè½¯ä»¶é¢„é˜²æ€§æ£€æŸ¥","description":"åˆ¶å®šç³»ç»Ÿè½¯ä»¶çš„é¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ"},{"id":"7.3.2","title":"åº”ç”¨è½¯ä»¶é¢„é˜²æ€§æ£€æŸ¥","description":"åˆ¶å®šåº”ç”¨è½¯ä»¶çš„é¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ"},{"id":"7.3.3","title":"æ•°æ®åº“é¢„é˜²æ€§æ£€æŸ¥","description":"åˆ¶å®šæ•°æ®åº“çš„é¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ"}]},{"id":"7.4","title":"æ£€æŸ¥ç»“æœå¤„ç†","description":"åˆ¶å®šæ£€æŸ¥ç»“æœçš„å¤„ç†æ–¹æ¡ˆ","children":[{"id":"7.4.1","title":"æ£€æŸ¥è®°å½•ç®¡ç†","description":"åˆ¶å®šæ£€æŸ¥è®°å½•çš„ç®¡ç†æ–¹æ¡ˆ"},{"id":"7.4.2","title":"é—®é¢˜æ•´æ”¹è·Ÿè¸ª","description":"åˆ¶å®šé—®é¢˜æ•´æ”¹çš„è·Ÿè¸ªæ–¹æ¡ˆ"},{"id":"7.4.3","title":"æ£€æŸ¥æ•ˆæœè¯„ä¼°","description":"åˆ¶å®šæ£€æŸ¥æ•ˆæœçš„è¯„ä¼°æ–¹æ³•"}]}]}]}'
        try:
            # è§£æJSON
            outline_data = json.loads(outline)
            if not isinstance(outline_data, dict) or 'outline' not in outline_data:
                yield "é”™è¯¯ï¼šæ— æ•ˆçš„outlineæ•°æ®æ ¼å¼"
                return

            # é€’å½’å¤„ç†outline
            yield "å¼€å§‹å¤„ç†outlineç»“æ„...\n"

            # æ”¶é›†æ‰€æœ‰å¤„ç†è¿‡ç¨‹ä¸­çš„æ¶ˆæ¯
            for message in self._process_outline_recursive(outline_data['outline'], "", []):
                yield message

            # é‡æ–°è½¬æ¢ä¸ºJSONå¹¶è¿”å›
            result_json = json.dumps(outline_data, ensure_ascii=False, indent=2)
            yield f"\nå¤„ç†å®Œæˆï¼ä»¥ä¸‹æ˜¯æ›´æ–°åçš„outlineï¼š\n{result_json}"

        except json.JSONDecodeError as e:
            yield f"JSONè§£æé”™è¯¯: {str(e)}"
        except Exception as e:
            yield f"å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}"

    def _process_outline_recursive(self, chapters: list, parent_path: str = "", parent_chapters: list = None):
        """
        é€’å½’å¤„ç†ç« èŠ‚åˆ—è¡¨

        Args:
            chapters: ç« èŠ‚åˆ—è¡¨
            parent_path: çˆ¶çº§è·¯å¾„
            parent_chapters: ä¸Šçº§ç« èŠ‚åˆ—è¡¨ï¼Œç”¨äºä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯

        Yields:
            å¤„ç†è¿‡ç¨‹ä¸­çš„çŠ¶æ€æ¶ˆæ¯
        """
        for i, chapter in enumerate(chapters):
            current_path = f"{parent_path}.{i}" if parent_path else str(i)
            chapter_id = chapter.get('id', f'unknown_{i}')
            chapter_title = chapter.get('title', 'æœªå‘½åç« èŠ‚')

            # æ£€æŸ¥æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹ï¼ˆæ²¡æœ‰childrenæˆ–childrenä¸ºç©ºï¼‰
            is_leaf = 'children' not in chapter or not chapter.get('children', [])

            # å‡†å¤‡å½“å‰ç« èŠ‚ä¿¡æ¯
            current_chapter_info = {
                'id': chapter_id,
                'title': chapter_title,
                'description': chapter.get('description', '')
            }

            # æ„å»ºå®Œæ•´çš„ä¸Šçº§ç« èŠ‚åˆ—è¡¨
            current_parent_chapters = []
            if parent_chapters:
                current_parent_chapters.extend(parent_chapters)
            current_parent_chapters.append(current_chapter_info)

            if is_leaf:
                # ä¸ºå¶å­èŠ‚ç‚¹ç”Ÿæˆå†…å®¹
                content = self._generate_chapter_content(chapter, parent_path, current_parent_chapters[:-1])
                if content:
                    chapter['content'] = content
                    yield f"âœ… ä¸ºç« èŠ‚ {chapter_id} '{chapter_title}' ç”Ÿæˆå†…å®¹å®Œæˆ\n"
                else:
                    yield f"âŒ ä¸ºç« èŠ‚ {chapter_id} '{chapter_title}' ç”Ÿæˆå†…å®¹å¤±è´¥\n"
            else:
                # é€’å½’å¤„ç†å­ç« èŠ‚
                yield f"ğŸ“ æ­£åœ¨å¤„ç†ç« èŠ‚ {chapter_id} '{chapter_title}' çš„å­ç« èŠ‚...\n"
                for message in self._process_outline_recursive(chapter['children'], current_path, current_parent_chapters):
                    yield message

    def _generate_chapter_content(self, chapter: dict, context_path: str = "", parent_chapters: list = None) -> str:
        """
        ä¸ºå•ä¸ªç« èŠ‚ç”Ÿæˆå†…å®¹

        Args:
            chapter: ç« èŠ‚æ•°æ®
            context_path: ä¸Šä¸‹æ–‡è·¯å¾„
            parent_chapters: ä¸Šçº§ç« èŠ‚åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ç« èŠ‚idã€æ ‡é¢˜å’Œæè¿°

        Returns:
            ç”Ÿæˆçš„å†…å®¹å­—ç¬¦ä¸²
        """
        try:
            chapter_id = chapter.get('id', 'unknown')
            chapter_title = chapter.get('title', 'æœªå‘½åç« èŠ‚')
            chapter_description = chapter.get('description', '')

            # æ„å»ºæç¤ºè¯
            system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ ‡ä¹¦ç¼–å†™ä¸“å®¶ï¼Œè´Ÿè´£ä¸ºæŠ•æ ‡æ–‡ä»¶çš„æŠ€æœ¯æ ‡éƒ¨åˆ†ç”Ÿæˆå…·ä½“å†…å®¹ã€‚

è¦æ±‚ï¼š
1. å†…å®¹è¦ä¸“ä¸šã€å‡†ç¡®ï¼Œä¸ç« èŠ‚æ ‡é¢˜å’Œæè¿°ä¿æŒä¸€è‡´
2. å†…å®¹è¦æœ‰é’ˆå¯¹æ€§å’Œè¯´æœåŠ›ï¼Œçªå‡ºæŠ€æœ¯èƒ½åŠ›å’Œä¼˜åŠ¿
3. è¯­è¨€è¦æ­£å¼ã€è§„èŒƒï¼Œç¬¦åˆæ ‡ä¹¦å†™ä½œè¦æ±‚
4. å†…å®¹è¦è¯¦ç»†å…·ä½“ï¼Œé¿å…ç©ºæ³›çš„æè¿°
5. ç›´æ¥è¿”å›ç« èŠ‚å†…å®¹ï¼Œä¸è¦ä»»ä½•é¢å¤–è¯´æ˜æˆ–æ ¼å¼æ ‡è®°
"""

            # æ„å»ºä¸Šçº§ç« èŠ‚ä¿¡æ¯
            parent_info = ""
            if parent_chapters:
                parent_info = "ä¸Šçº§ç« èŠ‚ä¿¡æ¯ï¼š\n"
                for parent in parent_chapters:
                    parent_info += f"- {parent['id']} {parent['title']}\n  {parent['description']}\n"

            user_prompt = f"""è¯·ä¸ºä»¥ä¸‹æ ‡ä¹¦ç« èŠ‚ç”Ÿæˆå…·ä½“å†…å®¹ï¼š

{parent_info if parent_info else ''}å½“å‰ç« èŠ‚ä¿¡æ¯ï¼š
ç« èŠ‚ID: {chapter_id}
ç« èŠ‚æ ‡é¢˜: {chapter_title}
ç« èŠ‚æè¿°: {chapter_description}

è¯·æ ¹æ®ä¸Šè¿°ç« èŠ‚å±‚çº§å…³ç³»ï¼Œç”Ÿæˆè¯¦ç»†çš„ä¸“ä¸šå†…å®¹ï¼Œç¡®ä¿ä¸ä¸Šçº§ç« èŠ‚çš„å†…å®¹é€»è¾‘ç›¸æ‰¿ï¼Œçªå‡ºæŠ€æœ¯æ–¹æ¡ˆçš„ä¼˜åŠ¿å’Œå¯è¡Œæ€§ã€‚"""

            # è°ƒç”¨AIç”Ÿæˆå†…å®¹
            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ]

            # æ”¶é›†æ‰€æœ‰ç”Ÿæˆçš„æ–‡æœ¬
            full_content = ""
            for chunk in self.stream_chat_completion(messages, temperature=0.7):
                full_content += chunk

            return full_content.strip()

        except Exception as e:
            print(f"ç”Ÿæˆç« èŠ‚å†…å®¹æ—¶å‡ºé”™: {str(e)}")
            return ""


def get_openai_service() -> OpenAIService:
    """
    è·å–OpenAIæœåŠ¡å®ä¾‹ï¼Œä½¿ç”¨ç¼“å­˜æœºåˆ¶é¿å…é‡å¤åˆ›å»º
    
    Returns:
        OpenAIServiceå®ä¾‹
    """
    # è·å–å½“å‰é…ç½®
    api_key = st.session_state.get('api_key', '')
    base_url = st.session_state.get('base_url', '')
    model_name = st.session_state.get('model_name', 'gpt-3.5-turbo')
    
    if not api_key:
        raise ValueError("è¯·å…ˆé…ç½®OpenAI APIå¯†é’¥")
    
    # æ£€æŸ¥ç¼“å­˜çš„æœåŠ¡å®ä¾‹æ˜¯å¦ä¸å½“å‰é…ç½®åŒ¹é…
    cached_service = st.session_state.get('openai_service_instance')
    if (cached_service and 
        cached_service.api_key == api_key and 
        cached_service.base_url == base_url and 
        cached_service.model_name == model_name):
        return cached_service
    
    # åˆ›å»ºæ–°çš„æœåŠ¡å®ä¾‹å¹¶ç¼“å­˜
    new_service = OpenAIService(api_key, base_url, model_name)
    st.session_state.openai_service_instance = new_service
    
    return new_service

def clear_openai_service_cache():
    """æ¸…é™¤OpenAIæœåŠ¡ç¼“å­˜"""
    if 'openai_service_instance' in st.session_state:
        del st.session_state.openai_service_instance 