import openai
import streamlit as st
from typing import Generator, Dict, Any
import json

class OpenAIService:
    """OpenAIæœåŠ¡ç±»ï¼Œæä¾›æµå¼å’Œéæµå¼è¯·æ±‚åŠŸèƒ½"""
    
    def __init__(self, api_key: str, base_url: str = None, model_name: str = "gpt-3.5-turbo"):
        """
        åˆå§‹åŒ–OpenAIæœåŠ¡
        
        Args:
            api_key: OpenAI APIå¯†é’¥
            base_url: åŸºç¡€URLï¼ˆå¯é€‰ï¼Œç”¨äºä»£ç†ï¼‰
            model_name: æ¨¡å‹åç§°
        """
        self.api_key = api_key
        self.base_url = base_url
        self.model_name = model_name
        
        # åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
        self.client = openai.OpenAI(
            api_key=api_key,
            base_url=base_url if base_url else None
        )
    
    def stream_chat_completion(
        self, 
        messages: list, 
        temperature: float = 0.7,
        response_format: dict = None
    ) -> Generator[str, None, None]:
        """
        æµå¼èŠå¤©å®Œæˆè¯·æ±‚
        
        Args:
            messages: æ¶ˆæ¯åˆ—è¡¨
            temperature: æ¸©åº¦å‚æ•°ï¼Œæ§åˆ¶éšæœºæ€§
            
        Yields:
            æµå¼è¿”å›çš„æ–‡æœ¬ç‰‡æ®µ
        """
        try:
            stream = self.client.chat.completions.create(
                model=self.model_name,
                messages=messages,
                temperature=temperature,
                stream=True,
                **({"response_format": response_format} if response_format is not None else {})
            )
            
            for chunk in stream:
                if chunk.choices[0].delta.content is not None:
                    yield chunk.choices[0].delta.content
                    
        except Exception as e:
            yield f"é”™è¯¯: {str(e)}"
    
    def analyze_document(self, file_content: str, analysis_type: str = "overview") -> Generator[str, None, None]:
        """
        åˆ†ææ–‡æ¡£å†…å®¹
        
        Args:
            file_content: æ–‡æ¡£å†…å®¹
            analysis_type: åˆ†æç±»å‹ ("overview" æˆ– "requirements")
            
        Yields:
            æµå¼åˆ†æç»“æœ
        """
        if analysis_type == "overview":
            system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ‹›æ ‡æ–‡ä»¶åˆ†æä¸“å®¶ã€‚è¯·åˆ†æä¸Šä¼ çš„æ‹›æ ‡æ–‡ä»¶ï¼Œæå–å¹¶æ€»ç»“é¡¹ç›®æ¦‚è¿°ä¿¡æ¯ã€‚
            
è¯·é‡ç‚¹å…³æ³¨ä»¥ä¸‹æ–¹é¢ï¼š
1. é¡¹ç›®åç§°å’ŒåŸºæœ¬ä¿¡æ¯
2. é¡¹ç›®èƒŒæ™¯å’Œç›®çš„
3. é¡¹ç›®è§„æ¨¡å’Œé¢„ç®—
4. é¡¹ç›®æ—¶é—´å®‰æ’
5. ä¸»è¦æŠ€æœ¯ç‰¹ç‚¹
6. å…³é”®è¦æ±‚

å·¥ä½œè¦æ±‚ï¼š
1. ä¿æŒæå–ä¿¡æ¯çš„å…¨é¢æ€§å’Œå‡†ç¡®æ€§ï¼Œå°½é‡ä½¿ç”¨åŸæ–‡å†…å®¹ï¼Œä¸è¦è‡ªå·±ç¼–å†™
2. åªå…³æ³¨ä¸é¡¹ç›®å®æ–½æœ‰å…³çš„å†…å®¹ï¼Œä¸æå–å•†åŠ¡ä¿¡æ¯
3. ç›´æ¥è¿”å›æ•´ç†å¥½çš„é¡¹ç›®æ¦‚è¿°ï¼Œé™¤æ­¤ä¹‹å¤–ä¸è¿”å›ä»»ä½•å…¶ä»–å†…å®¹
"""
        else:  # requirements
            system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ‹›æ ‡æ–‡ä»¶åˆ†æä¸“å®¶ã€‚è¯·åˆ†æä¸Šä¼ çš„æ‹›æ ‡æ–‡ä»¶ï¼Œæå–æŠ€æœ¯è¯„åˆ†è¦æ±‚,ä¸ºç¼–å†™æŠ•æ ‡æ–‡ä»¶ä¸­çš„æŠ€æœ¯æ–¹æ¡ˆåšå‡†å¤‡ã€‚
            
è¯·é‡ç‚¹å…³æ³¨ä»¥ä¸‹æ–¹é¢ï¼š
1. ç†è§£æŠ€æœ¯è¯„åˆ†çš„æ„æ€ï¼šç”¨äºç¼–å†™ã€è¯„æ¯”æŠ•æ ‡æ–‡ä»¶ä¸­æŠ€æœ¯æ ‡çš„æ ‡å‡†ï¼Œå…³æ³¨æŠ€æœ¯æ–¹æ¡ˆã€å®æ–½è®¡åˆ’ã€æŠ€æœ¯èƒ½åŠ›ã€è´¨é‡æ§åˆ¶ã€åˆ›æ–°æ€§ç­‰å†…å®¹ï¼Œé¿å…æ··æ·†å•†åŠ¡è¯„åˆ†ï¼ˆèµ„è´¨ã€ä¿¡èª‰ã€åˆåŒæ¡æ¬¾ï¼‰å’Œä»·æ ¼è¯„åˆ†ï¼ˆæŠ¥ä»·é‡‘é¢ï¼‰
2. ä»…æå–æŠ€æœ¯è¯„åˆ†é¡¹åŠç›¸å…³è¦æ±‚ï¼Œä¸åŒ…æ‹¬å•†åŠ¡ã€ä»·æ ¼åŠå…¶ä»–
3. ç”Ÿæˆå†…å®¹è¦ç¡®ä¿æ˜¯ä»æ‹›æ ‡æ–‡ä»¶ä¸­æå–çš„ï¼Œä¸è¦è‡ªå·±ç¼–å†™
4. ç›´æ¥è¿”å›æ•´ç†å¥½çš„æŠ€æœ¯è¯„åˆ†è¦æ±‚ï¼Œé™¤æ­¤ä¹‹å¤–ä¸è¿”å›ä»»ä½•å…¶ä»–å†…å®¹
"""
        analysis_type_cn = "é¡¹ç›®æ¦‚è¿°" if analysis_type == "overview" else "æŠ€æœ¯è¯„åˆ†è¦æ±‚"
        user_prompt = f"è¯·åˆ†æä»¥ä¸‹æ‹›æ ‡æ–‡ä»¶å†…å®¹ï¼Œæå–{analysis_type_cn}ä¿¡æ¯ï¼š\n\n{file_content}"
        
        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        # æµå¼è¿”å›åˆ†æç»“æœ
        for chunk in self.stream_chat_completion(messages, temperature=0.3):
            yield chunk
            
    def generate_outline(self, overview: str, requirements: str) -> Generator[str, None, None]:
        """
        ç”Ÿæˆæ ‡ä¹¦ç›®å½•ç»“æ„
        
        Args:
            overview: é¡¹ç›®æ¦‚è¿°ä¿¡æ¯
            requirements: æŠ€æœ¯è¯„åˆ†è¦æ±‚ä¿¡æ¯
            
        Yields:
            æµå¼è¿”å›çš„JSONæ ¼å¼ç›®å½•ç»“æ„
        """
        system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ ‡ä¹¦ç¼–å†™ä¸“å®¶ã€‚æ ¹æ®æä¾›çš„é¡¹ç›®æ¦‚è¿°å’ŒæŠ€æœ¯è¯„åˆ†è¦æ±‚ï¼Œç”ŸæˆæŠ•æ ‡æ–‡ä»¶ä¸­æŠ€æœ¯æ ‡éƒ¨åˆ†çš„ç›®å½•ç»“æ„ã€‚

è¦æ±‚ï¼š
1. ç›®å½•ç»“æ„è¦å…¨é¢è¦†ç›–æŠ€æœ¯æ ‡çš„æ‰€æœ‰å¿…è¦ç« èŠ‚
2. ç« èŠ‚åç§°è¦ä¸“ä¸šã€å‡†ç¡®ï¼Œç¬¦åˆæŠ•æ ‡æ–‡ä»¶è§„èŒƒ
3. ä¸€çº§ç›®å½•åç§°è¦ä¸æŠ€æœ¯è¯„åˆ†è¦æ±‚ä¸­çš„ç« èŠ‚åç§°ä¸€è‡´ï¼Œå¦‚æœæŠ€æœ¯è¯„åˆ†è¦æ±‚ä¸­æ²¡æœ‰ç« èŠ‚åç§°ï¼Œåˆ™ç»“åˆæŠ€æœ¯è¯„åˆ†è¦æ±‚ä¸­çš„å†…å®¹ï¼Œç”Ÿæˆä¸€çº§ç›®å½•åç§°
4. ä¸€å…±åŒ…æ‹¬ä¸‰çº§ç›®å½•
5. è¿”å›æ ‡å‡†JSONæ ¼å¼ï¼ŒåŒ…å«ç« èŠ‚ç¼–å·ã€æ ‡é¢˜ã€æè¿°å’Œå­ç« èŠ‚
6. é™¤äº†JSONç»“æœå¤–ï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹

JSONæ ¼å¼è¦æ±‚ï¼š
{
  "outline": [
    {
      "id": "1",
      "title": "",
      "description": "",
      "children": [
        {
          "id": "1.1",
          "title": "",
          "description": "",
          "children":[
              {
                "id": "1.1.1",
                "title": "",
                "description": ""
              }
          ]
        }
      ]
    }
  ]
}
"""
        
        user_prompt = f"""è¯·åŸºäºä»¥ä¸‹é¡¹ç›®ä¿¡æ¯ç”Ÿæˆæ ‡ä¹¦ç›®å½•ç»“æ„ï¼š

é¡¹ç›®æ¦‚è¿°ï¼š
{overview}

æŠ€æœ¯è¯„åˆ†è¦æ±‚ï¼š
{requirements}

è¯·ç”Ÿæˆå®Œæ•´çš„æŠ€æœ¯æ ‡ç›®å½•ç»“æ„ï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰æŠ€æœ¯è¯„åˆ†è¦ç‚¹ã€‚"""
        
        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        # æµå¼è¿”å›ç›®å½•ç»“æ„
        for chunk in self.stream_chat_completion(messages, temperature=0.7, response_format={"type": "json_object"}):
            print(chunk, end="")
            yield chunk

    def generate_content_single(self, outline: str, project_overview: str = "") -> Generator[str, None, None]:
        """
        é€’å½’éå†outlineï¼Œä¸ºå¶å­èŠ‚ç‚¹ç”Ÿæˆå†…å®¹

        Args:
            outline: JSONæ ¼å¼çš„outlineå­—ç¬¦ä¸²
            project_overview: é¡¹ç›®æ¦‚è¿°ä¿¡æ¯ï¼Œç”¨äºç”Ÿæˆæ›´å‡†ç¡®çš„å†…å®¹

        Yields:
            æµå¼è¿”å›å¤„ç†çŠ¶æ€å’Œç”Ÿæˆçš„content
        """
        outline = '{"outline":[{"id":"1","title":"é¡¹ç›®æ€»ä½“æ¦‚è¿°åŠè¿ç»´æ–¹æ¡ˆ","description":"é’ˆå¯¹æœ¬é¡¹ç›®æœ‰æ·±åˆ»è®¤è¯†ï¼Œæ€»ä½“æ¦‚è¿°æ¸…æ™°ã€åˆç†ï¼Œè¿ç»´æ–¹æ¡ˆä»¥åŠæªæ–½å…ˆè¿›ã€æˆç†Ÿå®Œå…¨æ»¡è¶³è§„èŒƒè¦æ±‚","children":[{"id":"1.1","title":"é¡¹ç›®æ¦‚è¿°","description":"ä»‹ç»é¡¹ç›®èƒŒæ™¯ã€ç›®æ ‡ã€èŒƒå›´ã€è§„æ¨¡ä¸é¢„ç®—ç­‰åŸºæœ¬æƒ…å†µ","children":[{"id":"1.1.1","title":"é¡¹ç›®èƒŒæ™¯ä¸æ„ä¹‰","description":"é˜è¿°å¤©æ´¥æ¸¯ä¿ç¨åŒºæ¶ˆé˜²æ•‘æ´æ”¯é˜Ÿæ¶ˆé˜²ç‰©è”ç½‘è¿œç¨‹ç›‘æ§ç³»ç»Ÿè¿ç»´æœåŠ¡é¡¹ç›®çš„èƒŒæ™¯å’Œé‡è¦æ„ä¹‰"},{"id":"1.1.2","title":"é¡¹ç›®ç›®æ ‡ä¸èŒƒå›´","description":"æ˜ç¡®é¡¹ç›®è¿ç»´ç›®æ ‡å’Œå…·ä½“æœåŠ¡èŒƒå›´ï¼ŒåŒ…æ‹¬ç›‘æ§ä¸­å¿ƒã€IDCæœºæˆ¿ã€é€šè®¯é“¾è·¯ã€å¹³å°è½¯ç¡¬ä»¶åŠå‰ç«¯è®¾å¤‡"},{"id":"1.1.3","title":"é¡¹ç›®è§„æ¨¡ä¸é¢„ç®—","description":"è¯¦ç»†è¯´æ˜é¡¹ç›®è§„æ¨¡å’Œé¢„ç®—æƒ…å†µï¼ŒåŒ…æ‹¬å„é¡¹èµ„æºé…ç½®å’Œè´¹ç”¨æ„æˆ"}]},{"id":"1.2","title":"è¿ç»´æ–¹æ¡ˆæ€»ä½“è®¾è®¡","description":"é˜è¿°è¿ç»´æœåŠ¡çš„æ€»ä½“è®¾è®¡ç†å¿µå’Œæ¶æ„","children":[{"id":"1.2.1","title":"è¿ç»´æœåŠ¡ç†å¿µä¸åŸåˆ™","description":"é˜è¿°è¿ç»´æœåŠ¡çš„æ ¸å¿ƒç†å¿µå’ŒåŸºæœ¬åŸåˆ™"},{"id":"1.2.2","title":"è¿ç»´æœåŠ¡ä½“ç³»æ¶æ„","description":"è®¾è®¡å®Œæ•´çš„è¿ç»´æœåŠ¡ä½“ç³»æ¶æ„ï¼ŒåŒ…æ‹¬ç»„ç»‡æ¶æ„ã€æµç¨‹æ¶æ„å’ŒæŠ€æœ¯æ¶æ„"},{"id":"1.2.3","title":"è¿ç»´æœåŠ¡æµç¨‹è®¾è®¡","description":"è®¾è®¡æ ‡å‡†åŒ–çš„è¿ç»´æœåŠ¡æµç¨‹ï¼Œç¡®ä¿æœåŠ¡è´¨é‡å’Œæ•ˆç‡"}]},{"id":"1.3","title":"è¿ç»´æœåŠ¡å†…å®¹","description":"è¯¦ç»†è¯´æ˜å„é¡¹è¿ç»´æœåŠ¡çš„å…·ä½“å†…å®¹å’Œå®æ–½æ–¹å¼","children":[{"id":"1.3.1","title":"ç›‘æ§ä¸­å¿ƒä¸IDCæœºæˆ¿è¿ç»´","description":"é˜è¿°ç›‘æ§ä¸­å¿ƒåœºåœ°å’ŒIDCæœºæˆ¿æœºæŸœçš„è¿ç»´æœåŠ¡å†…å®¹"},{"id":"1.3.2","title":"é€šè®¯é“¾è·¯è¿ç»´","description":"è¯´æ˜å›ºå®šIPä¸“çº¿ã€ç‰©è”ç½‘å¡å’Œè§†é¢‘ä¸“çº¿çš„è¿ç»´æœåŠ¡å†…å®¹"},{"id":"1.3.3","title":"å¹³å°è½¯ç¡¬ä»¶è¿ç»´","description":"é˜è¿°ç³»ç»Ÿå¹³å°è½¯ç¡¬ä»¶çš„æ—¥å¸¸ç»´æŠ¤å’Œä¼˜åŒ–æœåŠ¡å†…å®¹"},{"id":"1.3.4","title":"å‰ç«¯è®¾å¤‡ç”µæ± æ›´æ¢","description":"è¯¦ç»†è¯´æ˜ç”¨ä¼ è“„ç”µæ± å’Œä¼ æ„Ÿå™¨ç”µæ± çš„æ›´æ¢æ–¹æ¡ˆå’Œå®æ–½è®¡åˆ’"}]}]},{"id":"2","title":"æœ¬é¡¹ç›®æŠ•å…¥äººå‘˜å›¢é˜Ÿçš„è¯„ä»·","description":"å±•ç¤ºé¡¹ç›®å®æ–½äººå‘˜é…ç½®ã€æŠ€æœ¯å®åŠ›å’ŒåŒç±»é¡¹ç›®å®æ–½æˆ–æœåŠ¡ç»éªŒ","children":[{"id":"2.1","title":"äººå‘˜å›¢é˜Ÿæ€»ä½“æ„æˆ","description":"ä»‹ç»äººå‘˜å›¢é˜Ÿçš„æ•´ä½“æ„æˆæƒ…å†µ","children":[{"id":"2.1.1","title":"å›¢é˜Ÿè§„æ¨¡ä¸é…ç½®","description":"è¯¦ç»†è¯´æ˜å›¢é˜Ÿæ€»äººæ•°ã€ä¸“ä¸šé…ç½®å’Œäººå‘˜ç»“æ„"},{"id":"2.1.2","title":"å›¢é˜Ÿä¸“ä¸šç»“æ„","description":"é˜è¿°å›¢é˜Ÿæˆå‘˜çš„ä¸“ä¸šèƒŒæ™¯å’ŒæŠ€æœ¯ç‰¹é•¿åˆ†å¸ƒ"},{"id":"2.1.3","title":"å›¢é˜Ÿèµ„è´¨è®¤è¯","description":"åˆ—ä¸¾å›¢é˜Ÿæˆå‘˜æŒæœ‰çš„ç›¸å…³èµ„è´¨è¯ä¹¦å’Œä¸“ä¸šè®¤è¯"}]},{"id":"2.2","title":"æ ¸å¿ƒæŠ€æœ¯äººå‘˜ä»‹ç»","description":"è¯¦ç»†ä»‹ç»é¡¹ç›®æ ¸å¿ƒæŠ€æœ¯äººå‘˜çš„æƒ…å†µ","children":[{"id":"2.2.1","title":"é¡¹ç›®è´Ÿè´£äººèµ„è´¨ä¸ç»éªŒ","description":"ä»‹ç»é¡¹ç›®è´Ÿè´£äººçš„ä¸“ä¸šèµ„è´¨ã€ä»ä¸šç»éªŒå’Œé¡¹ç›®ç®¡ç†èƒ½åŠ›"},{"id":"2.2.2","title":"æŠ€æœ¯éª¨å¹²èµ„è´¨ä¸ç»éªŒ","description":"ä»‹ç»æŠ€æœ¯éª¨å¹²çš„ä¸“ä¸šèƒŒæ™¯ã€æŠ€æœ¯èƒ½åŠ›å’Œé¡¹ç›®ç»éªŒ"},{"id":"2.2.3","title":"æ¶ˆé˜²ä¸“ä¸šäººå‘˜èµ„è´¨ä¸ç»éªŒ","description":"ä»‹ç»æŒæœ‰æ¶ˆé˜²å‘˜è¯ä¹¦ç­‰ä¸“ä¸šèµ„è´¨çš„äººå‘˜æƒ…å†µ"}]},{"id":"2.3","title":"å›¢é˜Ÿä¸šç»©ä¸ç»éªŒ","description":"å±•ç¤ºå›¢é˜Ÿè¿‡å¾€çš„é¡¹ç›®ä¸šç»©å’Œç»éªŒç§¯ç´¯","children":[{"id":"2.3.1","title":"ç±»ä¼¼é¡¹ç›®å®æ–½ç»éªŒ","description":"åˆ—ä¸¾å›¢é˜Ÿå‚ä¸çš„ç±»ä¼¼æ¶ˆé˜²ç‰©è”ç½‘ç³»ç»Ÿé¡¹ç›®ç»éªŒ"},{"id":"2.3.2","title":"æ¶ˆé˜²ç‰©è”ç½‘ç³»ç»Ÿè¿ç»´ç»éªŒ","description":"è¯¦è¿°å›¢é˜Ÿåœ¨æ¶ˆé˜²ç‰©è”ç½‘ç³»ç»Ÿè¿ç»´æ–¹é¢çš„ä¸“ä¸šç»éªŒ"},{"id":"2.3.3","title":"æŠ€æœ¯åˆ›æ–°ä¸æˆæœ","description":"å±•ç¤ºå›¢é˜Ÿåœ¨ç›¸å…³é¢†åŸŸçš„æŠ€æœ¯åˆ›æ–°å’Œæˆæœ"}]}]},{"id":"3","title":"äººå‘˜ç»„ç»‡æ–¹æ¡ˆåŠåˆ†å·¥èŒè´£","description":"è¯¦ç»†è¯´æ˜äººå‘˜é…å¤‡æ–¹æ¡ˆã€ç»„ç»‡å®‰æ’å’ŒèŒè´£åˆ†å·¥","children":[{"id":"3.1","title":"ç»„ç»‡æ¶æ„è®¾è®¡","description":"è®¾è®¡åˆç†çš„è¿ç»´æœåŠ¡ç»„ç»‡æ¶æ„","children":[{"id":"3.1.1","title":"è¿ç»´æœåŠ¡ç»„ç»‡æ¶æ„","description":"è®¾è®¡å®Œæ•´çš„è¿ç»´æœåŠ¡ç»„ç»‡æ¶æ„å›¾å’Œè¯´æ˜"},{"id":"3.1.2","title":"ç®¡ç†å±‚çº§ä¸æ±‡æŠ¥å…³ç³»","description":"æ˜ç¡®å„ç®¡ç†å±‚çº§å’Œæ±‡æŠ¥å…³ç³»ï¼Œç¡®ä¿ä¿¡æ¯ç•…é€š"},{"id":"3.1.3","title":"ååŒå·¥ä½œæœºåˆ¶","description":"å»ºç«‹é«˜æ•ˆçš„å›¢é˜ŸååŒå·¥ä½œæœºåˆ¶ï¼Œæé«˜å·¥ä½œæ•ˆç‡"}]},{"id":"3.2","title":"å²—ä½èŒè´£åˆ’åˆ†","description":"æ˜ç¡®å„å²—ä½çš„å…·ä½“èŒè´£å’Œå·¥ä½œå†…å®¹","children":[{"id":"3.2.1","title":"é¡¹ç›®ç»ç†èŒè´£","description":"è¯¦ç»†è¯´æ˜é¡¹ç›®ç»ç†çš„èŒè´£èŒƒå›´å’Œå·¥ä½œè¦æ±‚"},{"id":"3.2.2","title":"æŠ€æœ¯è´Ÿè´£äººèŒè´£","description":"æ˜ç¡®æŠ€æœ¯è´Ÿè´£äººçš„èŒè´£èŒƒå›´å’ŒæŠ€æœ¯ç®¡ç†è¦æ±‚"},{"id":"3.2.3","title":"è¿ç»´äººå‘˜èŒè´£","description":"åˆ’åˆ†å„ç±»è¿ç»´äººå‘˜çš„å…·ä½“èŒè´£å’Œå·¥ä½œå†…å®¹"}]},{"id":"3.3","title":"äººå‘˜é…ç½®æ–¹æ¡ˆ","description":"è¯¦ç»†è¯´æ˜å„ç±»äººå‘˜çš„é…ç½®æ–¹æ¡ˆå’Œå·¥ä½œå®‰æ’","children":[{"id":"3.3.1","title":"ç›‘æ§ä¸­å¿ƒå€¼å®ˆäººå‘˜é…ç½®","description":"è¯´æ˜8äºº7X24å°æ—¶å€¼å®ˆäººå‘˜çš„é…ç½®æ–¹æ¡ˆå’Œå·¥ä½œå®‰æ’"},{"id":"3.3.2","title":"å‰ç«¯è®¾å¤‡è¿ç»´äººå‘˜é…ç½®","description":"è¯´æ˜3åç¡¬ä»¶æŠ€æœ¯äººå‘˜çš„é…ç½®æ–¹æ¡ˆå’Œå·¥ä½œèŒƒå›´"},{"id":"3.3.3","title":"ç³»ç»Ÿè½¯ä»¶è¿ç»´äººå‘˜é…ç½®","description":"è¯´æ˜ä¸å°‘äº2åè½¯ä»¶æŠ€æœ¯äººå‘˜çš„é…ç½®æ–¹æ¡ˆå’Œå·¥ä½œå†…å®¹"}]}]},{"id":"4","title":"å‰ç«¯ç¡¬ä»¶è®¾å¤‡è¿ç»´æ–¹æ¡ˆ","description":"å…¨é¢é˜è¿°æ¶ˆé˜²ç‰©è”ç½‘å‰ç«¯ç¡¬ä»¶è®¾å¤‡çš„è¿ç»´ã€ç»´ä¿å’Œç»´ä¿®æ–¹æ¡ˆ","children":[{"id":"4.1","title":"å‰ç«¯è®¾å¤‡æ¦‚å†µ","description":"ä»‹ç»å‰ç«¯è®¾å¤‡çš„åŸºæœ¬æƒ…å†µå’Œè¿ç»´éš¾ç‚¹","children":[{"id":"4.1.1","title":"è®¾å¤‡ç±»å‹ä¸åˆ†å¸ƒ","description":"è¯¦ç»†åˆ—å‡ºå‰ç«¯è®¾å¤‡çš„ç±»å‹ã€æ•°é‡å’Œåˆ†å¸ƒæƒ…å†µ"},{"id":"4.1.2","title":"è®¾å¤‡è¿è¡ŒçŠ¶æ€åˆ†æ","description":"åˆ†æå‰ç«¯è®¾å¤‡çš„å½“å‰è¿è¡ŒçŠ¶æ€å’Œæ½œåœ¨é—®é¢˜"},{"id":"4.1.3","title":"è®¾å¤‡è¿ç»´éš¾ç‚¹åˆ†æ","description":"åˆ†æå‰ç«¯è®¾å¤‡è¿ç»´è¿‡ç¨‹ä¸­çš„éš¾ç‚¹å’ŒæŒ‘æˆ˜"}]},{"id":"4.2","title":"è®¾å¤‡ç»´ä¿æ–¹æ¡ˆ","description":"åˆ¶å®šå‰ç«¯è®¾å¤‡çš„æ—¥å¸¸ç»´ä¿æ–¹æ¡ˆ","children":[{"id":"4.2.1","title":"æ—¥å¸¸å·¡æ£€è®¡åˆ’","description":"åˆ¶å®šè¯¦ç»†çš„æ—¥å¸¸å·¡æ£€è®¡åˆ’ï¼ŒåŒ…æ‹¬å·¡æ£€é¢‘ç‡ã€å†…å®¹å’Œæ ‡å‡†"},{"id":"4.2.2","title":"å®šæœŸç»´æŠ¤ä¿å…»","description":"åˆ¶å®šè®¾å¤‡å®šæœŸç»´æŠ¤ä¿å…»è®¡åˆ’ï¼Œç¡®ä¿è®¾å¤‡é•¿æœŸç¨³å®šè¿è¡Œ"},{"id":"4.2.3","title":"è®¾å¤‡æ€§èƒ½ä¼˜åŒ–","description":"æå‡ºè®¾å¤‡æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼Œæé«˜è®¾å¤‡è¿è¡Œæ•ˆç‡"}]},{"id":"4.3","title":"è®¾å¤‡ç»´ä¿®æ–¹æ¡ˆ","description":"åˆ¶å®šå‰ç«¯è®¾å¤‡æ•…éšœç»´ä¿®æ–¹æ¡ˆ","children":[{"id":"4.3.1","title":"æ•…éšœè¯Šæ–­æµç¨‹","description":"å»ºç«‹æ ‡å‡†åŒ–çš„æ•…éšœè¯Šæ–­æµç¨‹ï¼Œå¿«é€Ÿå®šä½é—®é¢˜"},{"id":"4.3.2","title":"ç»´ä¿®å“åº”æœºåˆ¶","description":"åˆ¶å®šé«˜æ•ˆçš„ç»´ä¿®å“åº”æœºåˆ¶ï¼Œç¡®ä¿åŠæ—¶å¤„ç†æ•…éšœ"},{"id":"4.3.3","title":"å¤‡å“å¤‡ä»¶ç®¡ç†","description":"å»ºç«‹å¤‡å“å¤‡ä»¶ç®¡ç†åˆ¶åº¦ï¼Œä¿éšœç»´ä¿®éœ€æ±‚"}]},{"id":"4.4","title":"ç”µæ± æ›´æ¢æ–¹æ¡ˆ","description":"è¯¦ç»†è¯´æ˜å‰ç«¯è®¾å¤‡ç”µæ± æ›´æ¢æ–¹æ¡ˆ","children":[{"id":"4.4.1","title":"ç”¨ä¼ è“„ç”µæ± æ›´æ¢æ–¹æ¡ˆ","description":"åˆ¶å®š260å—ç”¨ä¼ è“„ç”µæ± çš„æ›´æ¢æ–¹æ¡ˆå’Œå®æ–½è®¡åˆ’"},{"id":"4.4.2","title":"ä¼ æ„Ÿå™¨ç”µæ± æ›´æ¢æ–¹æ¡ˆ","description":"åˆ¶å®š1820å—ä¼ æ„Ÿå™¨ç”µæ± çš„æ›´æ¢æ–¹æ¡ˆå’Œå®æ–½è®¡åˆ’"},{"id":"4.4.3","title":"ç”µæ± æ›´æ¢è´¨é‡æ§åˆ¶","description":"å»ºç«‹ç”µæ± æ›´æ¢è´¨é‡æ§åˆ¶ä½“ç³»ï¼Œç¡®ä¿æ›´æ¢è´¨é‡"}]}]},{"id":"5","title":"è½¯ç¡¬ä»¶æ•…éšœåº”æ€¥å¤„ç†æ–¹æ¡ˆ","description":"åˆ¶å®šå…¨é¢ã€åˆç†ã€å¯è¡Œçš„è½¯ç¡¬ä»¶æ•…éšœåº”æ€¥å¤„ç†æ–¹æ¡ˆ","children":[{"id":"5.1","title":"åº”æ€¥å¤„ç†æ€»ä½“æ¶æ„","description":"è®¾è®¡åº”æ€¥å¤„ç†çš„æ€»ä½“æ¶æ„å’Œæœºåˆ¶","children":[{"id":"5.1.1","title":"åº”æ€¥å“åº”ç»„ç»‡","description":"å»ºç«‹åº”æ€¥å“åº”ç»„ç»‡æ¶æ„ï¼Œæ˜ç¡®å„å²—ä½èŒè´£"},{"id":"5.1.2","title":"åº”æ€¥å“åº”æµç¨‹","description":"åˆ¶å®šæ ‡å‡†åŒ–çš„åº”æ€¥å“åº”æµç¨‹ï¼Œç¡®ä¿å¿«é€Ÿå“åº”"},{"id":"5.1.3","title":"åº”æ€¥èµ„æºä¿éšœ","description":"é…ç½®å¿…è¦çš„åº”æ€¥èµ„æºï¼Œç¡®ä¿åº”æ€¥å¤„ç†èƒ½åŠ›"}]},{"id":"5.2","title":"æ•…éšœåˆ†çº§ä¸å“åº”æœºåˆ¶","description":"å»ºç«‹æ•…éšœåˆ†çº§æ ‡å‡†å’Œç›¸åº”çš„å“åº”æœºåˆ¶","children":[{"id":"5.2.1","title":"æ•…éšœç­‰çº§åˆ’åˆ†","description":"åˆ¶å®šæ•…éšœç­‰çº§åˆ’åˆ†æ ‡å‡†ï¼Œæ˜ç¡®å„çº§æ•…éšœçš„å®šä¹‰"},{"id":"5.2.2","title":"å“åº”æ—¶é—´è¦æ±‚","description":"è§„å®šä¸åŒç­‰çº§æ•…éšœçš„å“åº”æ—¶é—´å’Œå¤„ç†æ—¶é™"},{"id":"5.2.3","title":"å‡çº§å¤„ç†æœºåˆ¶","description":"å»ºç«‹æ•…éšœå‡çº§å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿é‡å¤§æ•…éšœå¾—åˆ°åŠæ—¶å¤„ç†"}]},{"id":"5.3","title":"å…¸å‹æ•…éšœå¤„ç†é¢„æ¡ˆ","description":"åˆ¶å®šå…¸å‹æ•…éšœçš„å¤„ç†é¢„æ¡ˆ","children":[{"id":"5.3.1","title":"ç³»ç»Ÿè½¯ä»¶æ•…éšœå¤„ç†é¢„æ¡ˆ","description":"åˆ¶å®šç³»ç»Ÿè½¯ä»¶æ•…éšœçš„åº”æ€¥å¤„ç†é¢„æ¡ˆ"},{"id":"5.3.2","title":"ç½‘ç»œé€šä¿¡æ•…éšœå¤„ç†é¢„æ¡ˆ","description":"åˆ¶å®šç½‘ç»œé€šä¿¡æ•…éšœçš„åº”æ€¥å¤„ç†é¢„æ¡ˆ"},{"id":"5.3.3","title":"å‰ç«¯è®¾å¤‡æ•…éšœå¤„ç†é¢„æ¡ˆ","description":"åˆ¶å®šå‰ç«¯è®¾å¤‡æ•…éšœçš„åº”æ€¥å¤„ç†é¢„æ¡ˆ"}]},{"id":"5.4","title":"åº”æ€¥æ¼”ç»ƒä¸è¯„ä¼°","description":"å»ºç«‹åº”æ€¥æ¼”ç»ƒå’Œè¯„ä¼°æœºåˆ¶","children":[{"id":"5.4.1","title":"åº”æ€¥æ¼”ç»ƒè®¡åˆ’","description":"åˆ¶å®šå®šæœŸåº”æ€¥æ¼”ç»ƒè®¡åˆ’ï¼Œæé«˜åº”æ€¥å¤„ç†èƒ½åŠ›"},{"id":"5.4.2","title":"æ¼”ç»ƒæ•ˆæœè¯„ä¼°","description":"å»ºç«‹æ¼”ç»ƒæ•ˆæœè¯„ä¼°æœºåˆ¶ï¼ŒæŒç»­æ”¹è¿›åº”æ€¥å¤„ç†èƒ½åŠ›"},{"id":"5.4.3","title":"é¢„æ¡ˆæŒç»­ä¼˜åŒ–","description":"æ ¹æ®æ¼”ç»ƒç»“æœå’Œå®é™…æƒ…å†µï¼ŒæŒç»­ä¼˜åŒ–åº”æ€¥é¢„æ¡ˆ"}]}]},{"id":"6","title":"äººå‘˜ç¨³å®šæ€§ä¿éšœæªæ–½","description":"åˆ¶å®šå®Œæ•´ã€åˆ‡å®å¯è¡Œçš„äººå‘˜ç¨³å®šæ€§ä¿éšœæªæ–½","children":[{"id":"6.1","title":"äººå‘˜ç®¡ç†åˆ¶åº¦","description":"å»ºç«‹å®Œå–„çš„äººå‘˜ç®¡ç†åˆ¶åº¦","children":[{"id":"6.1.1","title":"äººå‘˜æ‹›è˜ä¸é€‰æ‹”","description":"åˆ¶å®šç§‘å­¦çš„äººå‘˜æ‹›è˜ä¸é€‰æ‹”æœºåˆ¶ï¼Œç¡®ä¿äººå‘˜è´¨é‡"},{"id":"6.1.2","title":"è–ªé…¬ç¦åˆ©ä½“ç³»","description":"å»ºç«‹æœ‰ç«äº‰åŠ›çš„è–ªé…¬ç¦åˆ©ä½“ç³»ï¼Œæé«˜å‘˜å·¥æ»¡æ„åº¦"},{"id":"6.1.3","title":"èŒä¸šå‘å±•é€šé“","description":"è®¾è®¡æ¸…æ™°çš„èŒä¸šå‘å±•é€šé“ï¼Œå¢å¼ºå‘˜å·¥å½’å±æ„Ÿ"}]},{"id":"6.2","title":"äººå‘˜æ¿€åŠ±æªæ–½","description":"åˆ¶å®šæœ‰æ•ˆçš„äººå‘˜æ¿€åŠ±æªæ–½","children":[{"id":"6.2.1","title":"ç»©æ•ˆè€ƒæ ¸æœºåˆ¶","description":"å»ºç«‹ç§‘å­¦çš„ç»©æ•ˆè€ƒæ ¸æœºåˆ¶ï¼Œæ¿€å‘å‘˜å·¥å·¥ä½œç§¯ææ€§"},{"id":"6.2.2","title":"å¥–æƒ©åˆ¶åº¦","description":"åˆ¶å®šåˆç†çš„å¥–æƒ©åˆ¶åº¦ï¼Œå¼•å¯¼å‘˜å·¥è¡Œä¸º"},{"id":"6.2.3","title":"å›¢é˜Ÿå»ºè®¾æ´»åŠ¨","description":"ç»„ç»‡ä¸°å¯Œçš„å›¢é˜Ÿå»ºè®¾æ´»åŠ¨ï¼Œå¢å¼ºå›¢é˜Ÿå‡èšåŠ›"}]},{"id":"6.3","title":"äººå‘˜æ›¿æ¢æœºåˆ¶","description":"å»ºç«‹è§„èŒƒçš„äººå‘˜æ›¿æ¢æœºåˆ¶","children":[{"id":"6.3.1","title":"äººå‘˜æ›¿æ¢æµç¨‹","description":"åˆ¶å®šè§„èŒƒçš„äººå‘˜æ›¿æ¢æµç¨‹ï¼Œç¡®ä¿å·¥ä½œè¿ç»­æ€§"},{"id":"6.3.2","title":"çŸ¥è¯†è½¬ç§»æœºåˆ¶","description":"å»ºç«‹æœ‰æ•ˆçš„çŸ¥è¯†è½¬ç§»æœºåˆ¶ï¼Œä¿éšœç»éªŒä¼ æ‰¿"},{"id":"6.3.3","title":"å·¥ä½œäº¤æ¥æ ‡å‡†","description":"åˆ¶å®šæ ‡å‡†åŒ–çš„å·¥ä½œäº¤æ¥è§„èŒƒï¼Œç¡®ä¿æ— ç¼è¡”æ¥"}]}]},{"id":"7","title":"å®šæœŸé¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ","description":"åˆ¶å®šç»†è‡´ã€å…¨é¢ã€å¯æ“ä½œæ€§å¼ºçš„å®šæœŸé¢„é˜²æ€§æ£€æŸ¥æ–¹æ¡ˆ","children":[{"id":"7.1","title":"é¢„é˜²æ€§æ£€æŸ¥ä½“ç³»","description":"å»ºç«‹å®Œæ•´çš„é¢„é˜²æ€§æ£€æŸ¥ä½“ç³»","children":[{"id":"7.1.1","title":"æ£€æŸ¥å‘¨æœŸä¸é¢‘ç‡","description":"åˆ¶å®šåˆç†çš„æ£€æŸ¥å‘¨æœŸå’Œé¢‘ç‡ï¼Œç¡®ä¿åŠæ—¶å‘ç°é—®é¢˜"},{"id":"7.1.2","title":"æ£€æŸ¥å†…å®¹ä¸æ ‡å‡†","description":"æ˜ç¡®æ£€æŸ¥å†…å®¹å’Œæ ‡å‡†ï¼Œç¡®ä¿æ£€æŸ¥è´¨é‡"},{"id":"7.1.3","title":"æ£€æŸ¥æ–¹æ³•ä¸å·¥å…·","description":"é‡‡ç”¨ç§‘å­¦çš„æ£€æŸ¥æ–¹æ³•å’Œå·¥å…·ï¼Œæé«˜æ£€æŸ¥æ•ˆç‡"}]},{"id":"7.2","title":"ç³»ç»Ÿè½¯ä»¶æ£€æŸ¥æ–¹æ¡ˆ","description":"åˆ¶å®šç³»ç»Ÿè½¯ä»¶çš„å®šæœŸæ£€æŸ¥æ–¹æ¡ˆ","children":[{"id":"7.2.1","title":"å¹³å°ç³»ç»Ÿå¥åº·æ£€æŸ¥","description":"åˆ¶å®šå¹³å°ç³»ç»Ÿå¥åº·æ£€æŸ¥æ–¹æ¡ˆï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ"},{"id":"7.2.2","title":"æ•°æ®åº“æ€§èƒ½æ£€æŸ¥","description":"åˆ¶å®šæ•°æ®åº“æ€§èƒ½æ£€æŸ¥æ–¹æ¡ˆï¼Œä¼˜åŒ–æ•°æ®å¤„ç†æ•ˆç‡"},{"id":"7.2.3","title":"å®‰å…¨æ¼æ´æ£€æŸ¥","description":"åˆ¶å®šå®‰å…¨æ¼æ´æ£€æŸ¥æ–¹æ¡ˆï¼Œä¿éšœç³»ç»Ÿå®‰å…¨"}]},{"id":"7.3","title":"ç¡¬ä»¶è®¾å¤‡æ£€æŸ¥æ–¹æ¡ˆ","description":"åˆ¶å®šç¡¬ä»¶è®¾å¤‡çš„å®šæœŸæ£€æŸ¥æ–¹æ¡ˆ","children":[{"id":"7.3.1","title":"ç›‘æ§ä¸­å¿ƒè®¾å¤‡æ£€æŸ¥","description":"åˆ¶å®šç›‘æ§ä¸­å¿ƒè®¾å¤‡æ£€æŸ¥æ–¹æ¡ˆï¼Œç¡®ä¿è®¾å¤‡æ­£å¸¸è¿è¡Œ"},{"id":"7.3.2","title":"é€šä¿¡é“¾è·¯æ£€æŸ¥","description":"åˆ¶å®šé€šä¿¡é“¾è·¯æ£€æŸ¥æ–¹æ¡ˆï¼Œä¿éšœæ•°æ®ä¼ è¾“ç•…é€š"},{"id":"7.3.3","title":"å‰ç«¯è®¾å¤‡æ£€æŸ¥","description":"åˆ¶å®šå‰ç«¯è®¾å¤‡æ£€æŸ¥æ–¹æ¡ˆï¼Œç¡®ä¿è®¾å¤‡çŠ¶æ€è‰¯å¥½"}]},{"id":"7.4","title":"æ£€æŸ¥ç»“æœå¤„ç†ä¸æ”¹è¿›","description":"å»ºç«‹æ£€æŸ¥ç»“æœå¤„ç†å’ŒæŒç»­æ”¹è¿›æœºåˆ¶","children":[{"id":"7.4.1","title":"é—®é¢˜åˆ†çº§ä¸å¤„ç†","description":"å»ºç«‹é—®é¢˜åˆ†çº§å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿é—®é¢˜å¾—åˆ°åŠæ—¶è§£å†³"},{"id":"7.4.2","title":"æ”¹è¿›æªæ–½è·Ÿè¸ª","description":"å»ºç«‹æ”¹è¿›æªæ–½è·Ÿè¸ªæœºåˆ¶ï¼Œç¡®ä¿æ”¹è¿›æªæ–½è½å®åˆ°ä½"},{"id":"7.4.3","title":"æ£€æŸ¥æŠ¥å‘Šä¸æ€»ç»“","description":"åˆ¶å®šæ£€æŸ¥æŠ¥å‘Šå’Œæ€»ç»“åˆ¶åº¦ï¼Œä¸ºå†³ç­–æä¾›ä¾æ®"}]}]}]}'
        try:
            # è§£æJSON
            outline_data = json.loads(outline)
            if not isinstance(outline_data, dict) or 'outline' not in outline_data:
                yield "é”™è¯¯ï¼šæ— æ•ˆçš„outlineæ•°æ®æ ¼å¼"
                return

            # é€’å½’å¤„ç†outline
            yield "å¼€å§‹å¤„ç†outlineç»“æ„...\n"

            # æ”¶é›†æ‰€æœ‰å¤„ç†è¿‡ç¨‹ä¸­çš„æ¶ˆæ¯
            for message in self._process_outline_recursive(outline_data['outline'], "", [], project_overview):
                yield message

            # é‡æ–°è½¬æ¢ä¸ºJSONå¹¶è¿”å›
            result_json = json.dumps(outline_data, ensure_ascii=False, indent=2)
            yield f"\nå¤„ç†å®Œæˆï¼ä»¥ä¸‹æ˜¯æ›´æ–°åçš„outlineï¼š\n{result_json}"

        except json.JSONDecodeError as e:
            yield f"JSONè§£æé”™è¯¯: {str(e)}"
        except Exception as e:
            yield f"å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}"

    def _process_outline_recursive(self, chapters: list, parent_path: str = "", parent_chapters: list = None, project_overview: str = ""):
        """
        é€’å½’å¤„ç†ç« èŠ‚åˆ—è¡¨

        Args:
            chapters: ç« èŠ‚åˆ—è¡¨
            parent_path: çˆ¶çº§è·¯å¾„
            parent_chapters: ä¸Šçº§ç« èŠ‚åˆ—è¡¨ï¼Œç”¨äºä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯
            project_overview: é¡¹ç›®æ¦‚è¿°ä¿¡æ¯

        Yields:
            å¤„ç†è¿‡ç¨‹ä¸­çš„çŠ¶æ€æ¶ˆæ¯
        """
        for i, chapter in enumerate(chapters):
            current_path = f"{parent_path}.{i}" if parent_path else str(i)
            chapter_id = chapter.get('id', f'unknown_{i}')
            chapter_title = chapter.get('title', 'æœªå‘½åç« èŠ‚')

            # æ£€æŸ¥æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹ï¼ˆæ²¡æœ‰childrenæˆ–childrenä¸ºç©ºï¼‰
            is_leaf = 'children' not in chapter or not chapter.get('children', [])

            # å‡†å¤‡å½“å‰ç« èŠ‚ä¿¡æ¯
            current_chapter_info = {
                'id': chapter_id,
                'title': chapter_title,
                'description': chapter.get('description', '')
            }

            # æ„å»ºå®Œæ•´çš„ä¸Šçº§ç« èŠ‚åˆ—è¡¨
            current_parent_chapters = []
            if parent_chapters:
                current_parent_chapters.extend(parent_chapters)
            current_parent_chapters.append(current_chapter_info)

            if is_leaf:
                # ä¸ºå¶å­èŠ‚ç‚¹ç”Ÿæˆå†…å®¹
                # è·å–åŒçº§ç« èŠ‚ï¼ˆæ’é™¤å½“å‰ç« èŠ‚ï¼‰
                sibling_chapters = [ch for ch in chapters if ch.get('id') != chapter_id]
                content = self._generate_chapter_content(chapter, parent_path, current_parent_chapters[:-1], sibling_chapters, project_overview)
                if content:
                    chapter['content'] = content
                    yield f"âœ… ä¸ºç« èŠ‚ {chapter_id} '{chapter_title}' ç”Ÿæˆå†…å®¹å®Œæˆ\n"
                else:
                    yield f"âŒ ä¸ºç« èŠ‚ {chapter_id} '{chapter_title}' ç”Ÿæˆå†…å®¹å¤±è´¥\n"
            else:
                # é€’å½’å¤„ç†å­ç« èŠ‚
                yield f"ğŸ“ æ­£åœ¨å¤„ç†ç« èŠ‚ {chapter_id} '{chapter_title}' çš„å­ç« èŠ‚...\n"
                for message in self._process_outline_recursive(chapter['children'], current_path, current_parent_chapters, project_overview):
                    yield message

    def _generate_chapter_content(self, chapter: dict, context_path: str = "", parent_chapters: list = None, sibling_chapters: list = None, project_overview: str = "") -> str:
        """
        ä¸ºå•ä¸ªç« èŠ‚ç”Ÿæˆå†…å®¹

        Args:
            chapter: ç« èŠ‚æ•°æ®
            context_path: ä¸Šä¸‹æ–‡è·¯å¾„
            parent_chapters: ä¸Šçº§ç« èŠ‚åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ç« èŠ‚idã€æ ‡é¢˜å’Œæè¿°
            sibling_chapters: åŒçº§ç« èŠ‚åˆ—è¡¨ï¼Œé¿å…å†…å®¹é‡å¤
            project_overview: é¡¹ç›®æ¦‚è¿°ä¿¡æ¯ï¼Œæä¾›é¡¹ç›®èƒŒæ™¯å’Œè¦æ±‚

        Returns:
            ç”Ÿæˆçš„å†…å®¹å­—ç¬¦ä¸²
        """
        try:
            chapter_id = chapter.get('id', 'unknown')
            chapter_title = chapter.get('title', 'æœªå‘½åç« èŠ‚')
            chapter_description = chapter.get('description', '')

            # æ„å»ºæç¤ºè¯
            system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ ‡ä¹¦ç¼–å†™ä¸“å®¶ï¼Œè´Ÿè´£ä¸ºæŠ•æ ‡æ–‡ä»¶çš„æŠ€æœ¯æ ‡éƒ¨åˆ†ç”Ÿæˆå…·ä½“å†…å®¹ã€‚

è¦æ±‚ï¼š
1. å†…å®¹è¦ä¸“ä¸šã€å‡†ç¡®ï¼Œä¸ç« èŠ‚æ ‡é¢˜å’Œæè¿°ä¿æŒä¸€è‡´
2. è¿™æ˜¯æŠ€æœ¯æ–¹æ¡ˆï¼Œä¸æ˜¯å®£ä¼ æŠ¥å‘Šï¼Œæ³¨æ„æœ´å®æ— åï¼Œä¸è¦å‡å¤§ç©º
3. è¯­è¨€è¦æ­£å¼ã€è§„èŒƒï¼Œç¬¦åˆæ ‡ä¹¦å†™ä½œè¦æ±‚ï¼Œä½†ä¸è¦ä½¿ç”¨å¥‡æ€ªçš„è¿æ¥è¯ï¼Œä¸è¦è®©äººè§‰å¾—å†…å®¹åƒæ˜¯AIç”Ÿæˆçš„
4. å†…å®¹è¦è¯¦ç»†å…·ä½“ï¼Œé¿å…ç©ºæ³›çš„æè¿°
5. æ³¨æ„é¿å…ä¸åŒçº§ç« èŠ‚å†…å®¹é‡å¤ï¼Œä¿æŒå†…å®¹çš„ç‹¬ç‰¹æ€§å’Œäº’è¡¥æ€§
6. ç›´æ¥è¿”å›ç« èŠ‚å†…å®¹ï¼Œä¸æ ‡é¢˜ï¼Œä¸è¦ä»»ä½•é¢å¤–è¯´æ˜æˆ–æ ¼å¼æ ‡è®°
"""

            # æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
            context_info = ""
            
            # ä¸Šçº§ç« èŠ‚ä¿¡æ¯
            if parent_chapters:
                context_info += "ä¸Šçº§ç« èŠ‚ä¿¡æ¯ï¼š\n"
                for parent in parent_chapters:
                    context_info += f"- {parent['id']} {parent['title']}\n  {parent['description']}\n"
            
            # åŒçº§ç« èŠ‚ä¿¡æ¯ï¼ˆæ’é™¤å½“å‰ç« èŠ‚ï¼‰
            if sibling_chapters:
                context_info += "åŒçº§ç« èŠ‚ä¿¡æ¯ï¼ˆè¯·é¿å…å†…å®¹é‡å¤ï¼‰ï¼š\n"
                for sibling in sibling_chapters:
                    if sibling.get('id') != chapter_id:  # æ’é™¤å½“å‰ç« èŠ‚
                        context_info += f"- {sibling.get('id', 'unknown')} {sibling.get('title', 'æœªå‘½å')}\n  {sibling.get('description', '')}\n"

            # æ„å»ºç”¨æˆ·æç¤ºè¯
            project_info = ""
            if project_overview.strip():
                project_info = f"é¡¹ç›®æ¦‚è¿°ä¿¡æ¯ï¼š\n{project_overview}\n\n"
            
            user_prompt = f"""è¯·ä¸ºä»¥ä¸‹æ ‡ä¹¦ç« èŠ‚ç”Ÿæˆå…·ä½“å†…å®¹ï¼š

{project_info}{context_info if context_info else ''}å½“å‰ç« èŠ‚ä¿¡æ¯ï¼š
ç« èŠ‚ID: {chapter_id}
ç« èŠ‚æ ‡é¢˜: {chapter_title}
ç« èŠ‚æè¿°: {chapter_description}

è¯·æ ¹æ®é¡¹ç›®æ¦‚è¿°ä¿¡æ¯å’Œä¸Šè¿°ç« èŠ‚å±‚çº§å…³ç³»ï¼Œç”Ÿæˆè¯¦ç»†çš„ä¸“ä¸šå†…å®¹ï¼Œç¡®ä¿ä¸ä¸Šçº§ç« èŠ‚çš„å†…å®¹é€»è¾‘ç›¸æ‰¿ï¼ŒåŒæ—¶é¿å…ä¸åŒçº§ç« èŠ‚å†…å®¹é‡å¤ï¼Œçªå‡ºæœ¬ç« èŠ‚çš„ç‹¬ç‰¹æ€§å’ŒæŠ€æœ¯æ–¹æ¡ˆçš„ä¼˜åŠ¿ã€‚"""

            # è°ƒç”¨AIç”Ÿæˆå†…å®¹
            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ]

            # æ”¶é›†æ‰€æœ‰ç”Ÿæˆçš„æ–‡æœ¬
            full_content = ""
            for chunk in self.stream_chat_completion(messages, temperature=0.7):
                full_content += chunk

            return full_content.strip()

        except Exception as e:
            print(f"ç”Ÿæˆç« èŠ‚å†…å®¹æ—¶å‡ºé”™: {str(e)}")
            return ""


def get_openai_service() -> OpenAIService:
    """
    è·å–OpenAIæœåŠ¡å®ä¾‹ï¼Œä½¿ç”¨ç¼“å­˜æœºåˆ¶é¿å…é‡å¤åˆ›å»º
    
    Returns:
        OpenAIServiceå®ä¾‹
    """
    # è·å–å½“å‰é…ç½®
    api_key = st.session_state.get('api_key', '')
    base_url = st.session_state.get('base_url', '')
    model_name = st.session_state.get('model_name', 'gpt-3.5-turbo')
    
    if not api_key:
        raise ValueError("è¯·å…ˆé…ç½®OpenAI APIå¯†é’¥")
    
    # æ£€æŸ¥ç¼“å­˜çš„æœåŠ¡å®ä¾‹æ˜¯å¦ä¸å½“å‰é…ç½®åŒ¹é…
    cached_service = st.session_state.get('openai_service_instance')
    if (cached_service and 
        cached_service.api_key == api_key and 
        cached_service.base_url == base_url and 
        cached_service.model_name == model_name):
        return cached_service
    
    # åˆ›å»ºæ–°çš„æœåŠ¡å®ä¾‹å¹¶ç¼“å­˜
    new_service = OpenAIService(api_key, base_url, model_name)
    st.session_state.openai_service_instance = new_service
    
    return new_service

def clear_openai_service_cache():
    """æ¸…é™¤OpenAIæœåŠ¡ç¼“å­˜"""
    if 'openai_service_instance' in st.session_state:
        del st.session_state.openai_service_instance 